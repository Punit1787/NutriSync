<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>NutriSync â€“ Build Your Plan</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet"/>
<style>
  :root{--green:#2d6a4f;--gl:#52b788;--gp:#d8f3dc;--cream:#fefdf8;--dark:#1a2e1e;--gray:#6b7a6d;}
  *,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
  body{font-family:'DM Sans',sans-serif;background:var(--cream);color:var(--dark);min-height:100vh;}
  .page{display:grid;grid-template-columns:280px 1fr;min-height:100vh;}
  .sidebar{background:var(--dark);display:flex;flex-direction:column;position:sticky;top:0;height:100vh;}
  .st{padding:2rem 1.4rem 1.4rem;}
  .logo{font-family:'Playfair Display',serif;font-size:1.25rem;font-weight:900;color:var(--gl);margin-bottom:2.2rem;}
  .ps{display:flex;align-items:flex-start;gap:.85rem;margin-bottom:1.6rem;opacity:.42;transition:opacity .3s;}
  .ps.active{opacity:1;}.ps.done{opacity:.72;}
  .pc{width:29px;height:29px;border-radius:50%;border:2px solid #2d4a32;display:flex;align-items:center;justify-content:center;font-size:.76rem;font-weight:600;color:#8fb896;flex-shrink:0;transition:all .3s;}
  .ps.active .pc{border-color:var(--gl);background:var(--gl);color:var(--dark);}
  .ps.done .pc{border-color:var(--gl);color:var(--gl);}
  .pi h4{font-size:.82rem;font-weight:600;color:#b7d4bc;margin-bottom:.08rem;}
  .pi p{font-size:.7rem;color:#6a8a6f;}
  .pl{width:2px;height:14px;background:#2d4a32;margin:.22rem 0 .22rem 13px;}
  .sb2{margin-top:auto;padding:1.2rem 1.4rem;border-top:1px solid #2d4a32;}
  .sb2 a{color:#6a8a6f;font-size:.76rem;text-decoration:none;}
  .main{padding:2.8rem 3.2rem;max-width:660px;}
  .sh-tag{font-size:.7rem;font-weight:600;color:var(--gl);text-transform:uppercase;letter-spacing:2px;margin-bottom:.42rem;}
  .sh-title{font-family:'Playfair Display',serif;font-size:1.9rem;font-weight:900;line-height:1.2;margin-bottom:.42rem;}
  .sh-desc{color:var(--gray);font-size:.88rem;margin-bottom:2rem;}
  .fs{display:none;}.fs.active{display:block;animation:si .35s ease;}
  @keyframes si{from{opacity:0;transform:translateX(16px);}to{opacity:1;transform:none;}}
  .fg{margin-bottom:1.3rem;}
  .fg label{display:block;font-size:.78rem;font-weight:600;margin-bottom:.42rem;}
  .fr{display:grid;grid-template-columns:1fr 1fr;gap:.85rem;}
  input[type=text],input[type=number],input[type=date],select{width:100%;padding:.68rem .92rem;border:1.5px solid #dde8df;border-radius:10px;font-family:'DM Sans',sans-serif;font-size:.87rem;background:white;outline:none;transition:border .2s;}
  input:focus,select:focus{border-color:var(--gl);}
  .ut{display:flex;background:#eef5f0;border-radius:7px;overflow:hidden;margin-bottom:.42rem;width:fit-content;}
  .ut button{padding:.28rem .72rem;border:none;background:transparent;font-family:'DM Sans',sans-serif;font-size:.77rem;cursor:pointer;color:var(--gray);transition:all .2s;}
  .ut button.active{background:var(--green);color:white;border-radius:6px;}
  .chips{display:flex;flex-wrap:wrap;gap:.45rem;}
  .chip{padding:.36rem .86rem;border:1.5px solid #dde8df;border-radius:50px;font-size:.78rem;font-weight:500;cursor:pointer;transition:all .2s;background:white;color:var(--dark);}
  .chip:hover{border-color:var(--gl);}.chip.sel{background:var(--green);color:white;border-color:var(--green);}
  .cg{display:grid;grid-template-columns:repeat(auto-fill,minmax(108px,1fr));gap:.52rem;}
  .cc{padding:.72rem;border:1.5px solid #dde8df;border-radius:10px;cursor:pointer;transition:all .2s;background:white;text-align:center;}
  .cc:hover{border-color:var(--gl);}.cc.sel{background:var(--gp);border-color:var(--green);}
  .cc .ci{font-size:1.35rem;margin-bottom:.22rem;}.cc .cl{font-size:.73rem;font-weight:600;}
  .fnav{display:flex;gap:.85rem;margin-top:2.2rem;}
  .bnext{padding:.77rem 2.1rem;background:var(--green);color:white;border:none;border-radius:50px;font-family:'DM Sans',sans-serif;font-size:.88rem;font-weight:600;cursor:pointer;transition:all .22s;}
  .bnext:hover{background:var(--dark);}
  .bback{padding:.77rem 1.5rem;background:transparent;border:1.5px solid #dde8df;color:var(--gray);border-radius:50px;font-family:'DM Sans',sans-serif;font-size:.88rem;cursor:pointer;}
  .bback:hover{border-color:var(--green);}
  .bgen{padding:.77rem 2.2rem;background:linear-gradient(135deg,var(--green),var(--gl));color:white;border:none;border-radius:50px;font-family:'DM Sans',sans-serif;font-size:.92rem;font-weight:700;cursor:pointer;box-shadow:0 4px 16px rgba(45,106,79,.28);transition:all .22s;}
  .bgen:hover{transform:translateY(-2px);}.bgen:disabled{opacity:.6;cursor:not-allowed;transform:none;}

  /* LOADING */
  #lo{position:fixed;inset:0;background:rgba(254,253,248,.97);z-index:999;display:none;align-items:center;justify-content:center;flex-direction:column;gap:1rem;}
  #lo.show{display:flex;}
  .spin{width:52px;height:52px;border:4px solid var(--gp);border-top-color:var(--green);border-radius:50%;animation:spin .75s linear infinite;}
  @keyframes spin{to{transform:rotate(360deg);}}
  .lt{font-family:'Playfair Display',serif;font-size:1.2rem;font-weight:700;color:var(--green);}
  .lsteps{margin-top:.3rem;display:flex;flex-direction:column;gap:.3rem;}
  .lstep{font-size:.79rem;color:var(--gray);}.lstep.done{color:var(--gl);}

  /* RESULT */
  #rs{display:none;}#rs.show{display:block;}
  .voice-banner{background:linear-gradient(135deg,var(--dark),#1e3a24);border-radius:14px;padding:1.2rem 1.5rem;color:white;margin-bottom:1.3rem;display:flex;align-items:center;gap:.85rem;}
  .voice-icon{font-size:1.6rem;flex-shrink:0;}
  .voice-text{font-size:.88rem;line-height:1.55;color:#c8e6d0;}
  .safety-bar{display:flex;align-items:center;gap:.7rem;background:#f0fdf4;border:1.5px solid #86efac;border-radius:10px;padding:.65rem 1rem;margin-bottom:1.3rem;font-size:.82rem;}
  .safety-bar.fail{background:#fef2f2;border-color:#fca5a5;}
  .safety-icon{font-size:1.1rem;}
  .safety-title{font-weight:600;color:#166534;}
  .safety-note{color:#4b7c58;font-size:.74rem;}
  .rh{background:linear-gradient(135deg,var(--green),var(--gl));border-radius:16px;padding:1.5rem;color:white;margin-bottom:1.3rem;}
  .rh h2{font-family:'Playfair Display',serif;font-size:1.5rem;font-weight:900;margin-bottom:.18rem;}
  .rh-sub{font-size:.8rem;opacity:.85;margin-bottom:.85rem;}
  .cb{display:flex;gap:.9rem;flex-wrap:wrap;}
  .ci2{background:rgba(255,255,255,.18);border-radius:8px;padding:.38rem .78rem;font-size:.76rem;text-align:center;}
  .ci2 strong{display:block;font-size:1rem;font-weight:700;}
  .ai-tag{background:rgba(255,255,255,.25);border-radius:50px;padding:.14rem .58rem;font-size:.67rem;font-weight:700;margin-left:.4rem;vertical-align:middle;}
  .day-nav{display:flex;gap:.45rem;overflow-x:auto;padding-bottom:.3rem;scrollbar-width:none;margin-bottom:1.3rem;}
  .day-nav::-webkit-scrollbar{display:none;}
  .dntab{flex-shrink:0;padding:.42rem .85rem;border-radius:50px;border:1.5px solid #dde8df;font-size:.78rem;font-weight:600;cursor:pointer;background:white;color:var(--gray);transition:all .2s;}
  .dntab.active,.dntab:hover{background:var(--green);color:white;border-color:var(--green);}
  .meal-card{background:white;border-radius:13px;border:1px solid #e8f4ec;margin-bottom:.9rem;overflow:hidden;}
  .meal-header{display:flex;justify-content:space-between;align-items:center;padding:.9rem 1.1rem;cursor:pointer;transition:background .2s;user-select:none;}
  .meal-header:hover{background:#f8fdf9;}
  .meal-header-left{display:flex;align-items:center;gap:.7rem;}
  .mtype{padding:.18rem .6rem;border-radius:50px;font-size:.67rem;font-weight:700;}
  .tb{background:#fef9c3;color:#854d0e;}.tl{background:#dcfce7;color:#166534;}.td{background:#dbeafe;color:#1e40af;}.ts{background:#fce7f3;color:#9d174d;}
  .mname{font-weight:600;font-size:.88rem;}
  .mmeta{font-size:.7rem;color:var(--gray);margin-top:.08rem;}
  .mcal-tag{font-weight:700;color:var(--green);font-size:.92rem;flex-shrink:0;}
  .arr{color:var(--gray);font-size:.78rem;margin-left:.4rem;transition:transform .25s;}
  .arr.open{transform:rotate(180deg);}
  .meal-body{padding:0 1.1rem;max-height:0;overflow:hidden;transition:max-height .45s ease,padding .3s;}
  .meal-body.open{max-height:1400px;padding:0 1.1rem 1.1rem;}
  .macros-row{display:flex;gap:.55rem;margin-bottom:.9rem;flex-wrap:wrap;padding-top:.5rem;}
  .mpill{background:var(--gp);border-radius:8px;padding:.3rem .65rem;font-size:.72rem;text-align:center;min-width:65px;}
  .mval{font-weight:700;color:var(--green);display:block;font-size:.82rem;}
  .mlbl{color:var(--gray);font-size:.65rem;}
  .micro-row{display:flex;flex-wrap:wrap;gap:.3rem;margin-bottom:.9rem;}
  .mchip{background:#f0fdf4;border:1px solid #bbf7d0;border-radius:50px;padding:.15rem .55rem;font-size:.68rem;color:#166534;font-weight:500;}
  .sec-title{font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:.07rem;color:var(--gray);margin-bottom:.45rem;}
  .ing-table{width:100%;border-collapse:collapse;font-size:.78rem;margin-bottom:.9rem;}
  .ing-table th{text-align:left;padding:.28rem .45rem;color:var(--gray);font-size:.68rem;font-weight:600;border-bottom:1px solid #e8f4ec;}
  .ing-table td{padding:.3rem .45rem;border-bottom:1px solid #f5f5f5;}
  .ing-table tr:last-child td{border:none;}
  .explain-block{background:#fffbf0;border-left:3px solid #f4a261;border-radius:0 8px 8px 0;padding:.7rem .95rem;margin-bottom:.9rem;}
  .explain-block h4{font-size:.68rem;font-weight:700;color:#b45309;text-transform:uppercase;letter-spacing:.06rem;margin-bottom:.45rem;}
  .er{margin-bottom:.3rem;font-size:.79rem;line-height:1.5;}
  .elbl{font-weight:600;color:#92400e;}
  .allergy-ok{display:inline-flex;align-items:center;gap:.28rem;background:#f0fdf4;color:#166534;padding:.15rem .52rem;border-radius:50px;font-size:.68rem;font-weight:600;margin-top:.22rem;}
  .recipe-block{background:#f0f4ff;border-radius:10px;padding:.8rem .95rem;}
  .recipe-block h4{font-size:.68rem;font-weight:700;color:#1e40af;text-transform:uppercase;letter-spacing:.06rem;margin-bottom:.5rem;}
  .rmeta{display:flex;gap:.8rem;margin-bottom:.5rem;}
  .rmeta span{font-size:.7rem;color:var(--gray);}
  .rsteps{padding-left:1.1rem;}
  .rsteps li{margin-bottom:.25rem;line-height:1.5;color:#374151;font-size:.78rem;}
  .ract{display:flex;gap:.85rem;margin-top:1.5rem;flex-wrap:wrap;}
  .bsave{padding:.65rem 1.4rem;background:var(--green);color:white;border:none;border-radius:50px;font-family:'DM Sans',sans-serif;font-size:.84rem;font-weight:600;cursor:pointer;transition:background .2s;}
  .bsave:hover{background:var(--dark);}
  .bredo{padding:.65rem 1.4rem;background:white;color:var(--green);border:1.5px solid var(--green);border-radius:50px;font-family:'DM Sans',sans-serif;font-size:.84rem;cursor:pointer;}
  .err-box{background:#fee2e2;border:1px solid #fca5a5;border-radius:10px;padding:.85rem;margin-bottom:.9rem;font-size:.82rem;color:#dc2626;}
  @media(max-width:768px){.page{grid-template-columns:1fr;}.sidebar{display:none;}.main{padding:1.6rem 1rem;}}
</style>
</head>
<body>

<div id="lo">
  <div class="spin"></div>
  <div class="lt">ğŸŒ¿ Clinical AI generating your planâ€¦</div>
  <div style="color:var(--gray);font-size:.82rem">May take 20â€“35 seconds for a full 7-day plan</div>
  <div class="lsteps">
    <div class="lstep done">âœ“ Calculating BMR, TDEE & daily target</div>
    <div class="lstep" id="ls2">âŸ³ Sending to Clinical AI (Gemini)â€¦</div>
    <div class="lstep" id="ls3">âŸ³ Safety & allergy verificationâ€¦</div>
    <div class="lstep" id="ls4">âŸ³ Building recipes & explainabilityâ€¦</div>
    <div class="lstep" id="ls5">âŸ³ Finalizing 7-day scheduleâ€¦</div>
  </div>
</div>

<div class="page">
  <aside class="sidebar">
    <div class="st">
      <div class="logo">ğŸŒ¿ NutriSync</div>
      <div class="ps active" id="ps1"><div class="pc" id="pc1">1</div><div class="pi"><h4>Basic Info</h4><p>Age, height, weight</p></div></div>
      <div class="pl"></div>
      <div class="ps" id="ps2"><div class="pc" id="pc2">2</div><div class="pi"><h4>Goals & Activity</h4><p>Targets & conditions</p></div></div>
      <div class="pl"></div>
      <div class="ps" id="ps3"><div class="pc" id="pc3">3</div><div class="pi"><h4>Diet Preferences</h4><p>Food type & allergies</p></div></div>
      <div class="pl"></div>
      <div class="ps" id="ps4"><div class="pc" id="pc4">4</div><div class="pi"><h4>Cuisine & Budget</h4><p>Flavor & cost</p></div></div>
    </div>
    <div class="sb2"><a href="/">â† Back to Home</a></div>
  </aside>

  <main class="main">

    <!-- STEP 1 -->
    <div class="fs active" id="step1">
      <div class="sh-tag">Step 1 of 4</div>
      <div class="sh-title">Tell us about yourself</div>
      <div class="sh-desc">Used to calculate your precise basal metabolic rate.</div>
      <div class="fr">
        <div class="fg"><label>Date of Birth</label><input type="date" id="dob"/></div>
        <div class="fg"><label>Gender</label><div class="chips">
          <span class="chip" data-g="gender" onclick="selChip(this)">Male</span>
          <span class="chip" data-g="gender" onclick="selChip(this)">Female</span>
          <span class="chip" data-g="gender" onclick="selChip(this)">Other</span>
        </div></div>
      </div>
      <div class="fg">
        <label>Height</label>
        <div class="ut"><button class="active" id="ht-cm" onclick="setHU('cm')">cm</button><button id="ht-ft" onclick="setHU('ft')">ft / in</button></div>
        <div id="h-cm"><input type="number" id="hcm" placeholder="e.g. 170" min="100" max="250"/></div>
        <div id="h-ft" style="display:none" class="fr"><input type="number" id="hft" placeholder="ft"/><input type="number" id="hin" placeholder="in"/></div>
      </div>
      <div class="fg">
        <label>Weight</label>
        <div class="ut"><button class="active" id="wt-kg" onclick="setWU('kg')">kg</button><button id="wt-lb" onclick="setWU('lb')">lb</button></div>
        <input type="number" id="wt" placeholder="e.g. 70" min="30" max="300"/>
      </div>
      <div class="fnav"><button class="bnext" onclick="goNext(1)">Next â†’</button></div>
    </div>

    <!-- STEP 2 -->
    <div class="fs" id="step2">
      <div class="sh-tag">Step 2 of 4</div>
      <div class="sh-title">Goals & Activity</div>
      <div class="sh-desc">The AI respects medical conditions above fitness goals.</div>
      <div class="fg"><label>Fitness Goal</label><div class="chips">
        <span class="chip" data-g="goal" onclick="selChip(this)">ğŸ’ª Muscle Gain</span>
        <span class="chip" data-g="goal" onclick="selChip(this)">ğŸ”¥ Weight Loss</span>
        <span class="chip" data-g="goal" onclick="selChip(this)">âš–ï¸ Maintain Weight</span>
        <span class="chip" data-g="goal" onclick="selChip(this)">ğŸƒ Athletic Performance</span>
      </div></div>
      <div class="fg"><label>Activity Level</label>
        <select id="activity">
          <option value="">Select activity level</option>
          <option value="sedentary">Sedentary (desk job, no exercise)</option>
          <option value="light">Lightly Active (1â€“3 days/week)</option>
          <option value="moderate">Moderately Active (3â€“5 days/week)</option>
          <option value="very">Very Active (6â€“7 days/week)</option>
          <option value="extra">Extra Active (athlete / 2Ã— daily)</option>
        </select>
      </div>
      <div class="fg"><label>Medical Conditions <span style="font-weight:400;color:var(--gray);font-size:.72rem">(AI gives these highest priority)</span></label>
        <div class="chips" id="medChips">
          <span class="chip multi" onclick="togChip(this)">None</span>
          <span class="chip multi" onclick="togChip(this)">Diabetes</span>
          <span class="chip multi" onclick="togChip(this)">Hypertension</span>
          <span class="chip multi" onclick="togChip(this)">PCOS</span>
          <span class="chip multi" onclick="togChip(this)">Thyroid</span>
          <span class="chip multi" onclick="togChip(this)">High Cholesterol</span>
          <span class="chip multi" onclick="togChip(this)">IBS</span>
          <span class="chip multi" onclick="togChip(this)">Heart Condition</span>
        </div>
      </div>
      <div class="fnav"><button class="bback" onclick="goStep(1)">â† Back</button><button class="bnext" onclick="goNext(2)">Next â†’</button></div>
    </div>

    <!-- STEP 3 -->
    <div class="fs" id="step3">
      <div class="sh-tag">Step 3 of 4</div>
      <div class="sh-title">Diet Preferences</div>
      <div class="sh-desc">Allergies are hard constraints â€” never included in your plan.</div>
      <div class="fg"><label>Dietary Style</label><div class="chips">
        <span class="chip" data-g="diet" onclick="selChip(this)">ğŸ¥¬ Vegetarian</span>
        <span class="chip" data-g="diet" onclick="selChip(this)">ğŸŒ± Vegan</span>
        <span class="chip" data-g="diet" onclick="selChip(this)">ğŸ– Non-Vegetarian</span>
        <span class="chip" data-g="diet" onclick="selChip(this)">ğŸŸ Pescatarian</span>
      </div></div>
      <div class="fg"><label>Proteins You Eat</label><div class="chips" id="proteinChips">
        <span class="chip multi" onclick="togChip(this)">ğŸ¥š Eggs</span>
        <span class="chip multi" onclick="togChip(this)">ğŸ¥› Dairy</span>
        <span class="chip multi" onclick="togChip(this)">ğŸ— Chicken</span>
        <span class="chip multi" onclick="togChip(this)">ğŸ‘ Mutton</span>
        <span class="chip multi" onclick="togChip(this)">ğŸŸ Seafood</span>
        <span class="chip multi" onclick="togChip(this)">ğŸ„ Beef</span>
      </div></div>
      <div class="fg">
        <label style="color:#dc2626">âš ï¸ Allergies / Intolerances <span style="font-weight:400;font-size:.72rem;color:var(--gray)">(Hard constraint â€” AI will NEVER include these)</span></label>
        <div class="chips" id="allergyChips">
          <span class="chip multi" onclick="togChip(this)">ğŸ¥œ Peanuts</span>
          <span class="chip multi" onclick="togChip(this)">ğŸŒ¾ Gluten</span>
          <span class="chip multi" onclick="togChip(this)">ğŸ¥› Lactose</span>
          <span class="chip multi" onclick="togChip(this)">ğŸŒ° Tree Nuts</span>
          <span class="chip multi" onclick="togChip(this)">ğŸ³ Egg Allergy</span>
          <span class="chip multi sel" onclick="togChip(this)">âœ“ None</span>
        </div>
      </div>
      <div class="fnav"><button class="bback" onclick="goStep(2)">â† Back</button><button class="bnext" onclick="goNext(3)">Next â†’</button></div>
    </div>

    <!-- STEP 4 -->
    <div class="fs" id="step4">
      <div class="sh-tag">Step 4 of 4</div>
      <div class="sh-title">Cuisine & Budget</div>
      <div class="sh-desc">The AI picks ingredients accordingly.</div>
      <div class="fg"><label>Preferred Cuisines</label>
        <div class="cg">
          <div class="cc" onclick="togCC(this)" data-val="Indian"><div class="ci">ğŸ‡®ğŸ‡³</div><div class="cl">Indian</div></div>
          <div class="cc" onclick="togCC(this)" data-val="Mediterranean"><div class="ci">ğŸ«’</div><div class="cl">Mediterranean</div></div>
          <div class="cc" onclick="togCC(this)" data-val="Asian"><div class="ci">ğŸœ</div><div class="cl">Asian</div></div>
          <div class="cc" onclick="togCC(this)" data-val="Keto"><div class="ci">ğŸ¥‘</div><div class="cl">Keto</div></div>
          <div class="cc" onclick="togCC(this)" data-val="Continental"><div class="ci">ğŸ½ï¸</div><div class="cl">Continental</div></div>
          <div class="cc" onclick="togCC(this)" data-val="Middle Eastern"><div class="ci">ğŸ§†</div><div class="cl">Middle Eastern</div></div>
          <div class="cc" onclick="togCC(this)" data-val="Mexican"><div class="ci">ğŸŒ®</div><div class="cl">Mexican</div></div>
          <div class="cc" onclick="togCC(this)" data-val="Japanese"><div class="ci">ğŸ±</div><div class="cl">Japanese</div></div>
        </div>
      </div>
      <div class="fg"><label>Daily Budget</label><div class="chips">
        <span class="chip" data-g="budget" onclick="selChip(this)">ğŸŸ¢ Low (â‚¹200â€“400/day)</span>
        <span class="chip" data-g="budget" onclick="selChip(this)">ğŸŸ¡ Moderate (â‚¹400â€“800/day)</span>
        <span class="chip" data-g="budget" onclick="selChip(this)">ğŸ”µ Premium (â‚¹800+/day)</span>
      </div></div>
      <div class="fnav">
        <button class="bback" onclick="goStep(3)">â† Back</button>
        <button class="bgen" id="genBtn" onclick="generate()">ğŸš€ Generate My Clinical Plan</button>
      </div>
    </div>

    <!-- RESULT -->
    <div id="rs">
      <div class="voice-banner" id="voiceBanner" style="display:none">
        <div class="voice-icon">ğŸ™ï¸</div>
        <div class="voice-text" id="voiceText"></div>
      </div>
      <div class="safety-bar" id="safetyBar">
        <div class="safety-icon">ğŸ›¡ï¸</div>
        <div>
          <div class="safety-title" id="safetyTitle">âœ… Safety Check Passed</div>
          <div class="safety-note" id="safetyNote">All meals verified â€” no allergens present</div>
        </div>
      </div>
      <div class="rh">
        <h2>Your 7-Day Clinical Plan <span class="ai-tag" id="aitag">âœ¨ Gemini AI</span></h2>
        <div class="rh-sub">Tap any meal to expand macros Â· ingredients Â· recipe Â· AI explanation</div>
        <div class="cb">
          <div class="ci2"><strong id="rbmr">â€“</strong>BMR</div>
          <div class="ci2"><strong id="rtdee">â€“</strong>TDEE</div>
          <div class="ci2"><strong id="rcal">â€“</strong>kcal/day</div>
        </div>
      </div>
      <div class="err-box" id="errBox" style="display:none"></div>
      <div class="day-nav" id="dayNav"></div>
      <div id="planOut"></div>
      <div class="ract">
        <button class="bsave" onclick="savePlan()">ğŸ’¾ Save Plan</button>
        <button class="bredo" onclick="resetForm()">ğŸ”„ Regenerate</button>
        <button class="bsave" style="background:#1a2e1e" onclick="window.location.href='/dashboard'">ğŸ“Š Dashboard</button>
      </div>
    </div>
  </main>
</div>

<script>
  let step=1,hU='cm',wU='kg',lastPlan={},planDays=[];

  function setHU(u){hU=u;['cm','ft'].forEach(x=>document.getElementById('ht-'+x).classList.toggle('active',x===u));document.getElementById('h-cm').style.display=u==='cm'?'block':'none';document.getElementById('h-ft').style.display=u==='ft'?'grid':'none';}
  function setWU(u){wU=u;['kg','lb'].forEach(x=>document.getElementById('wt-'+x).classList.toggle('active',x===u));}
  function selChip(el){document.querySelectorAll(`.chip[data-g="${el.dataset.g}"]`).forEach(c=>c.classList.remove('sel'));el.classList.add('sel');}
  function togChip(el){el.classList.toggle('sel');}
  function togCC(el){el.classList.toggle('sel');}
  function gChip(g){const e=document.querySelector(`.chip.sel[data-g="${g}"]`);return e?e.textContent.replace(/^[^\w]+/,'').trim():'';}
  function gMulti(id){return[...document.querySelectorAll(`#${id} .chip.multi.sel`)].map(c=>c.textContent.replace(/[^\w\s]/g,'').trim()).filter(Boolean);}
  function gCards(){return[...document.querySelectorAll('.cc.sel')].map(c=>c.dataset.val);}

  function goStep(n){
    document.getElementById('step'+step)?.classList.remove('active');
    document.querySelectorAll('.ps').forEach((el,i)=>{
      el.classList.remove('active','done');const pc=el.querySelector('.pc');
      if(i+1<n){el.classList.add('done');pc.textContent='âœ“';}
      else if(i+1===n){el.classList.add('active');pc.textContent=i+1;}
      else pc.textContent=i+1;
    });
    step=n;document.getElementById('step'+n)?.classList.add('active');window.scrollTo(0,0);
  }

  function validate(n){
    if(n===1){
      if(!document.getElementById('dob').value){alert('Please enter your date of birth');return false;}
      if(!gChip('gender')){alert('Please select your gender');return false;}
      const hv=hU==='cm'?parseFloat(document.getElementById('hcm').value):parseFloat(document.getElementById('hft').value);
      if(!hv||hv<=0){alert('Please enter your height');return false;}
      if(!parseFloat(document.getElementById('wt').value)){alert('Please enter your weight');return false;}
    }
    if(n===2){if(!gChip('goal')){alert('Please select a goal');return false;}if(!document.getElementById('activity').value){alert('Please select activity level');return false;}}
    return true;
  }
  function goNext(n){if(validate(n))goStep(n+1);}

  function collectData(){
    const dob=document.getElementById('dob').value;
    const age=dob?Math.floor((new Date()-new Date(dob))/31557600000):25;
    let hcm=hU==='cm'?parseFloat(document.getElementById('hcm').value)||170:(parseFloat(document.getElementById('hft').value)||5)*30.48+(parseFloat(document.getElementById('hin').value)||7)*2.54;
    let wkg=parseFloat(document.getElementById('wt').value)||70;if(wU==='lb')wkg*=0.453592;
    const allergies=gMulti('allergyChips').filter(x=>!x.includes('None')&&x!=='None');
    const medical=gMulti('medChips').filter(x=>!x.includes('None')&&x!=='None');
    return{age:Math.max(10,Math.min(100,age)),gender:gChip('gender')||'Male',height_cm:Math.round(hcm),weight_kg:Math.round(wkg*10)/10,
      goal:gChip('goal')||'Maintain Weight',activity:document.getElementById('activity').value||'moderate',
      medical_conditions:medical,dietary_style:gChip('diet'),proteins:gMulti('proteinChips'),
      allergies,cuisines:gCards(),budget:gChip('budget')||'Moderate'};
  }

  function animateLoading(){
    [{id:'ls2',t:'âœ“ Sent to Clinical AI (Gemini)',d:2500},{id:'ls3',t:'âœ“ Allergy & safety checks running',d:9000},{id:'ls4',t:'âœ“ Building recipes & explainability',d:18000},{id:'ls5',t:'âœ“ Finalizing 7-day schedule',d:26000}]
    .forEach(({id,t,d})=>setTimeout(()=>{const e=document.getElementById(id);if(e){e.textContent=t;e.classList.add('done');}},d));
  }

  async function generate(){
    document.getElementById('genBtn').disabled=true;
    document.getElementById('lo').classList.add('show');
    animateLoading();
    const data=collectData();

    try{
      const r=await fetch('/api/generate-plan',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+(localStorage.getItem('token')||'')},body:JSON.stringify(data)});
      if(!r.ok){const e=await r.json();throw new Error(e.detail||'HTTP '+r.status);}
      const res=await r.json();
      lastPlan={...res,goal:data.goal};planDays=res.plan||[];
      showResult(res);
    }catch(e){
      console.error(e);
      const d2=data,bmrV=Math.round(10*d2.weight_kg+6.25*d2.height_cm-5*d2.age+(d2.gender==='Male'?5:-161));
      const mf={sedentary:1.2,light:1.375,moderate:1.55,very:1.725,extra:1.9}[d2.activity]||1.55;
      const tdeeV=Math.round(bmrV*mf),g=d2.goal.toLowerCase();
      const tc=g.includes('loss')?tdeeV-500:g.includes('gain')||g.includes('muscle')?tdeeV+300:tdeeV;
      const fb={bmr:bmrV,tdee:tdeeV,target_calories:tc,used_ai:false,error:e.message,
        safety_check:{allergy_verified:true,medical_condition_verified:true,conflicts_found:false,notes:'Smart fallback plan â€” verified safe'},
        voice_summary:`Your smart ${d2.goal} plan is ready, targeting ${tc} calories per day. Add your Gemini API key for the full clinical AI plan with detailed recipes and explanations.`,
        plan:buildFallback(tc,d2)};
      lastPlan={...fb,goal:d2.goal};planDays=fb.plan;showResult(fb);
    }finally{
      document.getElementById('lo').classList.remove('show');
      document.getElementById('genBtn').disabled=false;
    }
  }

  function buildFallback(cal,d){
    const days=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
    const B=Math.round(cal*.25),L=Math.round(cal*.30),D=Math.round(cal*.28),S=Math.round(cal*.085);
    const ind=!d.cuisines||d.cuisines.includes('Indian')||d.cuisines.length===0;
    const veg=d.dietary_style?.includes('Vegetarian')||d.dietary_style?.includes('Vegan');
    const ck=!veg&&d.proteins?.includes('Chicken'),eg=!veg&&d.proteins?.includes('Eggs'),sf=!veg&&d.proteins?.includes('Seafood');
    const allStr=d.allergies?.length?d.allergies.join(', '):'none';
    const mk=(type,name,cal,ingrs,p,c,f,micros,why,purpose,goal,steps,time,diff)=>({
      type,name,cal,total_calories:cal+' kcal',
      ingredients:ingrs.map(n=>({name:n,quantity:'as needed',calories:Math.round(cal/ingrs.length)})),
      macronutrients:{protein:p,carbohydrates:c,fats:f},micronutrients_highlight:micros,
      explainability:{why_selected:why,nutritional_purpose:purpose,goal_alignment:goal,allergy_confirmation:`âœ“ Confirmed safe â€” no ${allStr}`},
      recipe:{steps,cooking_time:time,difficulty:diff}
    });
    const sets=[[
      mk('Breakfast',ind?'Poha with peanuts & vegetables':'Oats with banana & almonds',B,ind?['Poha','Peanuts','Onion','Mustard seeds']:['Rolled oats','Banana','Almonds','Honey'],'8g','45g','6g',['Iron','Vitamin B6','Fiber'],'Balanced light morning meal','Complex carbs + plant protein for steady energy',`Controlled start supports ${d.goal}`,ind?['Heat oil, add mustard seeds','Add onion & chilli, sautÃ© 2 min','Add soaked poha, mix well','Add peanuts, lemon & coriander']:['Soak oats in milk overnight','Top with banana & almonds','Drizzle honey and serve'],'15 mins','Easy'),
      mk('Mid-Morning','Fresh fruit bowl',S,['Apple','Orange','Pomegranate'],'2g','28g','0.5g',['Vitamin C','Potassium','Antioxidants'],'Natural fiber prevents mid-morning crash','Vitamins and fiber for sustained energy',`Low-cal snack aligned with ${d.goal}`,['Wash and chop fruits','Combine in bowl','Add pinch of chaat masala (optional)'],'5 mins','Easy'),
      mk('Lunch',ck?'Grilled chicken rice bowl':ind?'Dal tadka + brown rice':'Chickpea quinoa bowl',L,ck?['Chicken breast','Basmati rice','Spinach','Spices']:ind?['Toor dal','Brown rice','Ghee','Turmeric']:['Chickpeas','Quinoa','Cucumber','Lemon'],ck?'35g':'18g','55g','10g',['Protein','Iron','Zinc'],'High-protein balanced midday meal','Complete amino acids + complex carbs',`Core meal driving ${d.goal}`,ck?['Marinate chicken 10 min','Grill 15 min per side','Cook rice','Serve with spinach']:ind?['Pressure cook dal','Make tadka with ghee & spices','Cook brown rice','Combine']:['Cook quinoa','Mix with chickpeas & veggies','Dress with lemon'],'30 mins','Medium'),
      mk('Evening',ind?'Roasted chana chaat':'Mixed nuts',S,ind?['Roasted chana','Lemon','Chaat masala']:['Almonds','Walnuts','Pumpkin seeds'],'6g','18g','5g',['Magnesium','Phosphorus'],'Protein snack prevents overeating at dinner','Sustained energy from protein + healthy fats',`Smart snack for ${d.goal}`,ind?['Mix chana with chopped onion','Add lemon & chaat masala','Serve fresh']:['Portion 30g nuts','Eat mindfully'],'5 mins','Easy'),
      mk('Dinner',sf?'Grilled fish + vegetables':ind?'Paneer bhurji + roti':'Red lentil soup',D,sf?['Fish','Broccoli','Olive oil']:ind?['Paneer','Capsicum','Onion','Roti']:['Red lentils','Carrot','Spinach','Bread'],sf?'32g':ind?'22g':'18g','30g','12g',['Omega-3','Calcium','Vitamin D'],'Light protein-rich dinner for recovery','Amino acids + calcium for overnight recovery',`Dinner optimized for ${d.goal}`,sf?['Season fish with lemon & herbs','Grill 5 min per side','Steam vegetables']:ind?['SautÃ© onion & capsicum','Add crumbled paneer + spices','Cook 5 min','Serve with rotis']:['Cook lentils 15 min','Add sautÃ©ed carrots & spinach','Season','Serve with bread'],'25 mins','Medium')
    ]];
    return days.map((day,i)=>({day,total_day_calories:cal,meals:sets[i%sets.length]}));
  }

  function showResult(res){
    document.querySelectorAll('.fs').forEach(s=>s.classList.remove('active'));
    document.getElementById('rs').classList.add('show');
    document.getElementById('aitag').textContent=res.used_ai?'âœ¨ Clinical AI (Gemini)':'ğŸ“‹ Smart Fallback';
    document.getElementById('rbmr').textContent=res.bmr||'â€“';
    document.getElementById('rtdee').textContent=res.tdee||'â€“';
    document.getElementById('rcal').textContent=res.target_calories||res.daily_calorie_target||'â€“';
    if(res.voice_summary){document.getElementById('voiceText').textContent=res.voice_summary;document.getElementById('voiceBanner').style.display='flex';}
    const sc=res.safety_check||{};const ok=sc.conflicts_found!==true&&sc.allergy_verified!==false;
    document.getElementById('safetyBar').className='safety-bar'+(ok?'':' fail');
    document.getElementById('safetyTitle').textContent=ok?'âœ… Safety Check Passed':'âš ï¸ Conflict Detected';
    document.getElementById('safetyTitle').style.color=ok?'#166534':'#dc2626';
    document.getElementById('safetyNote').textContent=sc.notes||'All meals verified safe';
    if(res.error&&!res.used_ai){document.getElementById('errBox').style.display='block';document.getElementById('errBox').textContent='â„¹ï¸ Using smart fallback (Gemini unavailable: '+res.error+'). Add GEMINI_API_KEY in .env for full clinical AI with recipes & explanations.';}
    const nav=document.getElementById('dayNav');
    nav.innerHTML=(res.plan||[]).map((d,i)=>`<div class="dntab${i===0?' active':''}" onclick="switchDay(${i},this)">${d.day.slice(0,3)}</div>`).join('');
    renderDay(0);window.scrollTo(0,0);
  }

  function switchDay(i,el){document.querySelectorAll('.dntab').forEach(t=>t.classList.remove('active'));el.classList.add('active');renderDay(i);}

  function renderDay(i){
    const day=planDays[i];if(!day)return;
    const badges={Breakfast:'tb',Lunch:'tl',Dinner:'td','Mid-Morning':'ts',Evening:'ts'};
    document.getElementById('planOut').innerHTML=(day.meals||[]).map((m,mi)=>{
      const ingList=(m.ingredients||[]);
      const ingRows=ingList.map(ing=>{
        const n=typeof ing==='string'?ing:ing.name||ing;
        const q=typeof ing==='object'?ing.quantity||'â€“':'â€“';
        const c=typeof ing==='object'?ing.calories||'â€“':'â€“';
        return`<tr><td>${n}</td><td style="color:var(--gray)">${q}</td><td><strong>${c} kcal</strong></td></tr>`;
      }).join('');
      const mac=m.macronutrients||{};
      const micros=(m.micronutrients_highlight||[]).map(n=>`<span class="mchip">âœ¦ ${n}</span>`).join('');
      const exp=m.explainability||{};
      const rec=m.recipe||{};
      const previewIngr=ingList.slice(0,3).map(i=>typeof i==='string'?i:i.name).join(', ')+(ingList.length>3?'â€¦':'');
      return`<div class="meal-card">
        <div class="meal-header" onclick="togMeal(${mi})">
          <div class="meal-header-left">
            <span class="mtype ${badges[m.type]||'ts'}">${m.type}</span>
            <div><div class="mname">${m.name}</div><div class="mmeta">${previewIngr}</div></div>
          </div>
          <div style="display:flex;align-items:center;gap:.4rem">
            <div class="mcal-tag">${m.cal||''} kcal</div>
            <div class="arr" id="arr${mi}">â–¼</div>
          </div>
        </div>
        <div class="meal-body" id="body${mi}">
          ${mac.protein||mac.carbohydrates?`<div class="macros-row">
            ${mac.protein?`<div class="mpill"><span class="mval">${mac.protein}</span><span class="mlbl">Protein</span></div>`:''}
            ${mac.carbohydrates?`<div class="mpill"><span class="mval">${mac.carbohydrates}</span><span class="mlbl">Carbs</span></div>`:''}
            ${mac.fats?`<div class="mpill"><span class="mval">${mac.fats}</span><span class="mlbl">Fats</span></div>`:''}
          </div>`:''}
          ${micros?`<div class="micro-row">${micros}</div>`:''}
          ${ingRows?`<div class="sec-title">Ingredients</div><table class="ing-table"><thead><tr><th>Ingredient</th><th>Quantity</th><th>Calories</th></tr></thead><tbody>${ingRows}</tbody></table>`:''}
          ${exp.why_selected?`<div class="explain-block">
            <h4>ğŸ§  AI Explainability</h4>
            <div class="er"><span class="elbl">Why selected: </span>${exp.why_selected}</div>
            <div class="er"><span class="elbl">Nutritional purpose: </span>${exp.nutritional_purpose||'â€“'}</div>
            <div class="er"><span class="elbl">Goal alignment: </span>${exp.goal_alignment||'â€“'}</div>
            <div><span class="allergy-ok">ğŸ›¡ï¸ ${exp.allergy_confirmation||'Confirmed safe'}</span></div>
          </div>`:''}
          ${rec.steps?.length?`<div class="recipe-block">
            <h4>ğŸ³ Recipe</h4>
            <div class="rmeta">${rec.cooking_time?`<span>â± ${rec.cooking_time}</span>`:''}${rec.difficulty?`<span>ğŸ“Š ${rec.difficulty}</span>`:''}</div>
            <ol class="rsteps">${rec.steps.map(s=>`<li>${s}</li>`).join('')}</ol>
          </div>`:''}
        </div>
      </div>`;
    }).join('');
  }

  function togMeal(i){
    const b=document.getElementById('body'+i),a=document.getElementById('arr'+i);
    const open=b.classList.toggle('open');a.classList.toggle('open',open);
  }

  async function savePlan(){
    if(!localStorage.getItem('token')){if(confirm('Login to save your plan?'))window.location.href='/';return;}
    try{const r=await fetch('/api/save-plan',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+localStorage.getItem('token')},body:JSON.stringify(lastPlan)});
    alert(r.ok?'âœ… Plan saved to dashboard!':'Could not save');}catch{alert('Server error');}
  }

  function resetForm(){
    document.getElementById('rs').classList.remove('show');
    document.getElementById('errBox').style.display='none';
    document.getElementById('voiceBanner').style.display='none';
    ['ls2','ls3','ls4','ls5'].forEach((id,i)=>{const e=document.getElementById(id);if(e){e.classList.remove('done');e.textContent=['âŸ³ Sending to Clinical AI (Gemini)â€¦','âŸ³ Safety & allergy verificationâ€¦','âŸ³ Building recipes & explainabilityâ€¦','âŸ³ Finalizing 7-day scheduleâ€¦'][i];}});
    goStep(1);
  }
</script>
</body>
</html>