<!DOCTYPE html>
<html lang="en">
<head>
<script>
  // Auto-detect API base: use Render URL when hosted, localhost when developing
  window.API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
    ? 'http://localhost:8000'
    : 'https://nutrisync-vgjj.onrender.com';
</script>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>NutriSync тАУ Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet"/>
<style>
  :root{--green:#2d6a4f;--gl:#52b788;--gp:#d8f3dc;--cream:#fefdf8;--dark:#1a2e1e;--gray:#6b7a6d;--red:#dc2626;--amber:#d97706;--blue:#1e40af;}
  *,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
  body{font-family:'DM Sans',sans-serif;background:#f0f7f2;color:var(--dark);}
  .app{display:grid;grid-template-columns:250px 1fr;min-height:100vh;}
  .sidebar{background:var(--dark);display:flex;flex-direction:column;position:sticky;top:0;height:100vh;}
  .sidebar-top{padding:2rem 1.4rem 1.4rem;}
  .logo{font-family:'Playfair Display',serif;font-size:1.25rem;font-weight:900;color:var(--gl);margin-bottom:2rem;}
  .nav-item{display:flex;align-items:center;gap:.75rem;padding:.65rem .9rem;border-radius:9px;cursor:pointer;color:#8fb896;font-size:.86rem;font-weight:500;transition:all .2s;margin-bottom:.15rem;text-decoration:none;}
  .nav-item:hover{background:#1e3a24;color:white;}
  .nav-item.active{background:var(--green);color:white;}
  .nav-icon{font-size:1rem;width:18px;text-align:center;}
  .sidebar-bottom{margin-top:auto;padding:1.3rem;border-top:1px solid #2d4a32;}
  .user-card{display:flex;align-items:center;gap:.75rem;}
  .uav{width:34px;height:34px;border-radius:50%;background:var(--green);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.85rem;color:white;}
  .uname{font-size:.83rem;font-weight:600;color:#b7d4bc;}
  .uemail{font-size:.72rem;color:#6a8a6f;margin-top:.1rem;}
  .logout-btn{background:none;border:none;color:#6a8a6f;font-size:.73rem;cursor:pointer;margin-top:.7rem;font-family:'DM Sans',sans-serif;display:block;}
  .logout-btn:hover{color:#e63946;}
  .content{padding:2.2rem;}
  .page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:2rem;}
  .page-header h1{font-family:'Playfair Display',serif;font-size:1.7rem;font-weight:900;}
  .page-header p{color:var(--gray);font-size:.87rem;margin-top:.18rem;}
  .new-btn{padding:.65rem 1.4rem;background:var(--green);color:white;border:none;border-radius:50px;font-family:'DM Sans',sans-serif;font-size:.85rem;font-weight:600;cursor:pointer;transition:all .22s;}
  .new-btn:hover{background:var(--dark);}
  .lang-btn{padding:.5rem 1rem;background:none;border:1.5px solid #dde8df;border-radius:50px;font-family:'DM Sans',sans-serif;font-size:.78rem;font-weight:600;cursor:pointer;color:var(--gray);transition:all .2s;margin-right:.5rem;}
  .lang-btn:hover{border-color:var(--green);color:var(--green);}
  #dashLangMenu{display:none;}
  #dashLangMenu.open{display:block!important;}

  .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;margin-bottom:2rem;}
  .sc{background:white;border-radius:14px;padding:1.3rem;border:1px solid #e8f4ec;transition:transform .2s;}
  .sc:hover{transform:translateY(-2px);}
  .sc.green{background:linear-gradient(135deg,var(--green),var(--gl));color:white;}
  .sc.green .sv,.sc.green .sc2{color:white;}
  .sc.green .sl{color:rgba(255,255,255,.8);}
  .si{font-size:1.4rem;margin-bottom:.7rem;}
  .sv{font-family:'Playfair Display',serif;font-size:1.7rem;font-weight:900;color:var(--dark);}
  .sl{font-size:.78rem;color:var(--gray);margin-top:.15rem;}
  .sc2{font-size:.72rem;margin-top:.4rem;color:var(--gl);}

  /* TABS */
  .dash-tabs{display:flex;gap:.5rem;margin-bottom:1.5rem;border-bottom:2px solid #e8f4ec;padding-bottom:0;}
  .dash-tab{padding:.65rem 1.2rem;background:none;border:none;font-family:'DM Sans',sans-serif;font-size:.85rem;font-weight:600;color:var(--gray);cursor:pointer;border-bottom:2.5px solid transparent;margin-bottom:-2px;transition:all .2s;}
  .dash-tab:hover{color:var(--green);}
  .dash-tab.active{color:var(--green);border-bottom-color:var(--green);}
  .dash-panel{display:none;}.dash-panel.active{display:block;}

  .mgrid{display:grid;grid-template-columns:1fr 320px;gap:1.8rem;}
  .card{background:white;border-radius:18px;padding:1.6rem;border:1px solid #e8f4ec;margin-bottom:1.5rem;}
  .card:last-child{margin-bottom:0;}
  .ct{font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:700;margin-bottom:1.3rem;display:flex;align-items:center;gap:.5rem;}

  /* PLAN */
  .plan-sum{background:linear-gradient(135deg,#f0f9f2,#e8f5ec);border-radius:12px;padding:1.3rem;margin-bottom:1.3rem;border:1px solid #c8e6d0;}
  .pdate{font-size:.76rem;color:var(--gray);margin-bottom:.2rem;}
  .pname{font-size:.95rem;font-weight:600;margin-bottom:.9rem;}
  .macros{display:flex;gap:.9rem;flex-wrap:wrap;}
  .mb{background:white;border-radius:7px;padding:.38rem .75rem;font-size:.78rem;border:1px solid #d8f3dc;text-align:center;}
  .mv{font-weight:700;color:var(--green);}
  .ml{font-size:.68rem;color:var(--gray);}
  .day-scroll{display:flex;gap:.7rem;overflow-x:auto;padding-bottom:.4rem;scrollbar-width:none;margin-bottom:1.3rem;}
  .day-scroll::-webkit-scrollbar{display:none;}
  .dp{flex-shrink:0;padding:.5rem .9rem;border-radius:50px;border:1.5px solid #dde8df;font-size:.8rem;font-weight:600;cursor:pointer;transition:all .2s;background:white;color:var(--gray);}
  .dp.active,.dp:hover{background:var(--green);color:white;border-color:var(--green);}
  .mr{display:flex;justify-content:space-between;align-items:center;padding:.8rem 0;border-bottom:1px solid #f5f5f5;font-size:.85rem;}
  .mr:last-child{border:none;}
  .mt-badge{padding:.18rem .65rem;border-radius:50px;font-size:.7rem;font-weight:600;}
  .b{background:#fef9c3;color:#854d0e;}.l{background:#dcfce7;color:#166534;}.d{background:#dbeafe;color:#1e40af;}.s{background:#fce7f3;color:#9d174d;}
  .mn{font-size:.85rem;font-weight:500;margin-top:.18rem;}
  .mc{font-size:.8rem;color:var(--green);font-weight:600;}
  .ingr-sm{font-size:.7rem;color:#94a3b8;margin-top:.1rem;}
  .fit-card{background:linear-gradient(135deg,var(--dark),#1e3a24);border-radius:18px;padding:1.6rem;margin-bottom:1.5rem;color:white;}
  .fit-card h3{font-family:'Playfair Display',serif;font-size:1rem;font-weight:700;margin-bottom:.25rem;}
  .fit-card p{font-size:.8rem;color:#8fb896;margin-bottom:1.1rem;}
  .fit-stats{display:grid;grid-template-columns:1fr 1fr;gap:.7rem;margin-bottom:1.1rem;}
  .fs{background:rgba(255,255,255,.08);border-radius:9px;padding:.7rem;text-align:center;}
  .fsv{font-size:1.1rem;font-weight:700;color:var(--gl);}
  .fsl{font-size:.68rem;color:#8fb896;margin-top:.15rem;}
  .conn-btn{width:100%;padding:.65rem;background:var(--gl);color:var(--dark);border:none;border-radius:9px;font-family:'DM Sans',sans-serif;font-size:.85rem;font-weight:700;cursor:pointer;transition:all .2s;}
  .conn-btn:hover{background:white;}
  .conn-btn.conn{background:#1a2e1e;color:var(--gl);}
  .ring-wrap{position:relative;display:inline-block;}
  .ring-text{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;}
  .rv{font-family:'Playfair Display',serif;font-size:1.3rem;font-weight:900;color:var(--green);}
  .rl{font-size:.7rem;color:var(--gray);}
  .pi{display:flex;justify-content:space-between;align-items:center;padding:.85rem 0;border-bottom:1px solid #f0f0f0;}
  .pi:last-child{border:none;}
  .pidate{font-size:.76rem;color:var(--gray);}
  .pigoal{font-size:.85rem;font-weight:500;}
  .piv{cursor:pointer;font-size:.76rem;color:var(--green);font-weight:600;}
  .plan-modal{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px);}
  .plan-modal.open{display:flex;}
  .pm-inner{background:white;border-radius:20px;padding:2rem;width:90%;max-width:600px;max-height:85vh;overflow-y:auto;position:relative;}
  .pm-close{position:absolute;top:1rem;right:1rem;background:none;border:none;font-size:1.2rem;cursor:pointer;}
  .pm-title{font-family:'Playfair Display',serif;font-size:1.4rem;font-weight:900;margin-bottom:1.2rem;color:var(--green);}
  .pm-day{background:var(--cream);border-radius:12px;padding:1.1rem;margin-bottom:.9rem;}
  .pm-day h4{font-weight:700;color:var(--dark);margin-bottom:.7rem;}
  .no-plan{text-align:center;padding:3rem 2rem;color:var(--gray);}
  .no-plan .np-icon{font-size:3rem;margin-bottom:1rem;}
  .no-plan p{margin-bottom:1.2rem;font-size:.92rem;}
  .no-plan button{padding:.7rem 1.8rem;background:var(--green);color:white;border:none;border-radius:50px;font-family:'DM Sans',sans-serif;font-size:.9rem;font-weight:600;cursor:pointer;}

  /* Monthly Tracker */
  .month-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.2rem;}
  .month-nav{display:flex;align-items:center;gap:.7rem;}
  .month-btn{background:none;border:1.5px solid #dde8df;border-radius:50px;padding:.32rem .75rem;font-size:.8rem;cursor:pointer;color:var(--gray);transition:all .2s;}
  .month-btn:hover{border-color:var(--green);color:var(--green);}
  .month-label{font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:700;}
  .month-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:.8rem;margin-bottom:1.5rem;}
  .ms{background:#f8fdf9;border-radius:10px;padding:.9rem;border:1px solid #e8f4ec;text-align:center;}
  .msv{font-family:'Playfair Display',serif;font-size:1.3rem;font-weight:900;color:var(--green);}
  .msl{font-size:.7rem;color:var(--gray);margin-top:.15rem;}
  .warn-box{border-radius:12px;padding:.9rem 1.1rem;margin-bottom:.75rem;display:flex;gap:.7rem;align-items:flex-start;}
  .warn-box.danger{background:#fef2f2;border:1.5px solid #fca5a5;}
  .warn-box.warning{background:#fff7ed;border:1.5px solid #fed7aa;}
  .warn-box.info{background:#eff6ff;border:1.5px solid #bfdbfe;}
  .warn-icon{font-size:1.2rem;flex-shrink:0;margin-top:.05rem;}
  .warn-title{font-weight:700;font-size:.85rem;margin-bottom:.2rem;}
  .warn-danger .warn-title{color:#dc2626;}
  .warn-warning .warn-title{color:#d97706;}
  .warn-info .warn-title{color:#1e40af;}
  .warn-msg{font-size:.76rem;line-height:1.55;}
  .warn-danger .warn-msg{color:#7f1d1d;}
  .warn-warning .warn-msg{color:#78350f;}
  .warn-info .warn-msg{color:#1e3a5f;}
  .day-bars{display:flex;flex-direction:column;gap:.5rem;}
  .day-bar-row{display:flex;align-items:center;gap:.7rem;font-size:.76rem;}
  .day-bar-label{width:32px;text-align:right;color:var(--gray);flex-shrink:0;}
  .day-bar-track{flex:1;background:#f0f7f2;border-radius:50px;height:10px;overflow:hidden;}
  .day-bar-fill{height:100%;border-radius:50px;background:linear-gradient(90deg,var(--green),var(--gl));transition:width .6s ease;}
  .day-bar-val{width:55px;text-align:right;font-weight:600;color:var(--dark);flex-shrink:0;}
  .log-form{background:#f8fdf9;border-radius:14px;border:1px solid #e8f4ec;padding:1.3rem;margin-bottom:1rem;}
  .log-form h4{font-size:.85rem;font-weight:700;margin-bottom:.9rem;}
  .lf-grid{display:grid;grid-template-columns:1fr 1fr;gap:.65rem;margin-bottom:.65rem;}
  .lf-grid input,.lf-grid select{width:100%;padding:.55rem .75rem;border:1.5px solid #dde8df;border-radius:9px;font-family:'DM Sans',sans-serif;font-size:.8rem;background:white;outline:none;transition:border .2s;}
  .lf-grid input:focus,.lf-grid select:focus{border-color:var(--gl);}
  .log-submit{padding:.6rem 1.5rem;background:var(--green);color:white;border:none;border-radius:50px;font-family:'DM Sans',sans-serif;font-size:.82rem;font-weight:600;cursor:pointer;transition:all .2s;}
  .log-submit:hover{background:var(--dark);}
  .macro-chart{display:grid;grid-template-columns:1fr 1fr 1fr;gap:.7rem;margin-bottom:1.2rem;}
  .macro-bar{background:white;border-radius:10px;border:1px solid #e8f4ec;padding:.75rem;text-align:center;}
  .macro-bar-label{font-size:.7rem;color:var(--gray);margin-bottom:.35rem;}
  .macro-bar-ring{position:relative;width:50px;height:50px;margin:0 auto .35rem;}
  .macro-bar-val{font-family:'Playfair Display',serif;font-size:.95rem;font-weight:900;color:var(--dark);}
  .macro-bar-unit{font-size:.65rem;color:var(--gray);}

  @media(max-width:1100px){.stats{grid-template-columns:1fr 1fr;}.month-stats{grid-template-columns:1fr 1fr;}}
  @media(max-width:900px){.mgrid{grid-template-columns:1fr;}}
  @media(max-width:768px){
    .app{grid-template-columns:1fr;}
    .sidebar{display:none;}
    .content{padding:1rem .9rem;}
    .stats{grid-template-columns:1fr 1fr;gap:.7rem;}
    .sc{padding:1rem;}
    .sv{font-size:1.35rem;}
    .page-header{flex-direction:column;align-items:flex-start;gap:.8rem;}
    .page-header>div:last-child{width:100%;display:flex;justify-content:space-between;align-items:center;}
    .dash-tabs{overflow-x:auto;scrollbar-width:none;gap:.2rem;-webkit-overflow-scrolling:touch;}
    .dash-tabs::-webkit-scrollbar{display:none;}
    .dash-tab{white-space:nowrap;padding:.55rem .8rem;font-size:.78rem;}
    .card{padding:1.1rem;}
    .month-stats{grid-template-columns:1fr 1fr;}
    .macro-chart{grid-template-columns:1fr 1fr 1fr;}
    /* NatureSync mobile */
    .ns-grid{grid-template-columns:1fr;}
    .ns-score-wrap{flex-direction:column;text-align:center;gap:.8rem;}
    .ns-score-text{text-align:center;}
    .ns-hero{padding:1.3rem;}
    .ns-tips{padding:1rem;}
  }
  @media(max-width:480px){
    .stats{grid-template-columns:1fr 1fr;}
    .sc .si{font-size:1.1rem;}
    .sv{font-size:1.15rem;}
    .sl{font-size:.7rem;}
    .page-header h1{font-size:1.3rem;}
    /* NatureSync tips side-by-side on small */
    #panel-nature>div:last-child{grid-template-columns:1fr;}
  }

  /* тФАтФА NATURESYNC тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА */
  .ns-hero{background:linear-gradient(135deg,#0a3d1f,#1a5c32,#2d8a50);border-radius:20px;padding:1.8rem;color:white;margin-bottom:1.8rem;position:relative;overflow:hidden;}
  .ns-hero::before{content:'ЁЯМ┐';position:absolute;right:-10px;top:-15px;font-size:7rem;opacity:.12;}
  .ns-hero h2{font-family:'Playfair Display',serif;font-size:1.4rem;font-weight:900;margin-bottom:.3rem;}
  .ns-hero p{font-size:.83rem;color:#a8d5b5;margin-bottom:1.2rem;}
  .ns-score-wrap{display:flex;align-items:center;gap:1.5rem;}
  .ns-score-ring{position:relative;flex-shrink:0;}
  .ns-score-label{text-align:center;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);}
  .ns-score-num{font-family:'Playfair Display',serif;font-size:1.5rem;font-weight:900;color:white;}
  .ns-score-sub{font-size:.58rem;color:#a8d5b5;display:block;}
  .ns-score-text h3{font-size:1rem;font-weight:700;margin-bottom:.25rem;}
  .ns-score-text p{font-size:.76rem;color:#a8d5b5;line-height:1.5;}
  .ns-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:1.2rem;margin-bottom:1.5rem;}
  @media(max-width:900px){.ns-grid{grid-template-columns:1fr;}}
  .ns-card{background:white;border-radius:16px;padding:1.4rem;border:1px solid #e8f4ec;transition:transform .2s,box-shadow .2s;}
  .ns-card:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(45,106,79,.1);}
  .ns-card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;}
  .ns-card-title{display:flex;align-items:center;gap:.55rem;font-weight:700;font-size:.9rem;}
  .ns-icon-wrap{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.1rem;}
  .ns-icon-blue{background:#eff6ff;}
  .ns-icon-yellow{background:#fefce8;}
  .ns-icon-green{background:#f0fdf4;}
  .ns-icon-purple{background:#faf5ff;}
  .ns-badge{padding:.22rem .65rem;border-radius:50px;font-size:.68rem;font-weight:700;}
  .ns-badge-blue{background:#dbeafe;color:#1e40af;}
  .ns-badge-yellow{background:#fef9c3;color:#854d0e;}
  .ns-badge-green{background:#dcfce7;color:#166534;}
  .ns-badge-purple{background:#f3e8ff;color:#6b21a8;}
  .ns-progress-bar{background:#f0f7f2;border-radius:50px;height:10px;overflow:hidden;margin-bottom:.5rem;}
  .ns-progress-fill{height:100%;border-radius:50px;transition:width .8s ease;}
  .ns-fill-blue{background:linear-gradient(90deg,#3b82f6,#60a5fa);}
  .ns-fill-yellow{background:linear-gradient(90deg,#f59e0b,#fbbf24);}
  .ns-fill-green{background:linear-gradient(90deg,#22c55e,#4ade80);}
  .ns-fill-purple{background:linear-gradient(90deg,#a855f7,#c084fc);}
  .ns-progress-nums{display:flex;justify-content:space-between;font-size:.72rem;color:var(--gray);}
  .ns-progress-nums span:first-child{font-weight:700;color:var(--dark);}
  .ns-stepper{display:flex;align-items:center;gap:.65rem;margin-top:.8rem;}
  .ns-step-btn{width:32px;height:32px;border-radius:50%;border:1.5px solid #dde8df;background:white;font-size:1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;font-weight:600;}
  .ns-step-btn:hover{background:var(--green);color:white;border-color:var(--green);}
  .ns-step-val{font-family:'Playfair Display',serif;font-size:1.4rem;font-weight:900;color:var(--dark);min-width:36px;text-align:center;}
  .ns-step-label{font-size:.75rem;color:var(--gray);}
  .ns-slider-wrap{margin-top:.8rem;}
  .ns-slider{-webkit-appearance:none;appearance:none;width:100%;height:8px;border-radius:50px;outline:none;cursor:pointer;margin-bottom:.4rem;}
  .ns-slider.sun{background:linear-gradient(90deg,#fef9c3 0%,#f59e0b 100%);}
  .ns-slider.sleep{background:linear-gradient(90deg,#f3e8ff 0%,#a855f7 100%);}
  .ns-slider.air{background:linear-gradient(90deg,#f0fdf4 0%,#22c55e 100%);}
  .ns-slider::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;border-radius:50%;cursor:pointer;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,.2);}
  .ns-slider.sun::-webkit-slider-thumb{background:#f59e0b;}
  .ns-slider.sleep::-webkit-slider-thumb{background:#a855f7;}
  .ns-slider.air::-webkit-slider-thumb{background:#22c55e;}
  .ns-insight{background:linear-gradient(135deg,#f0fdf4,#ecfdf5);border:1px solid #bbf7d0;border-radius:12px;padding:1rem 1.2rem;margin-top:.8rem;}
  .ns-insight p{font-size:.78rem;color:#166534;line-height:1.6;}
  .ns-insight p strong{color:#14532d;}
  .ns-tips{background:white;border-radius:16px;padding:1.4rem;border:1px solid #e8f4ec;margin-bottom:1.2rem;}
  .ns-tips h4{font-family:'Playfair Display',serif;font-size:1rem;font-weight:700;margin-bottom:1rem;display:flex;align-items:center;gap:.5rem;}
  .ns-tip-item{display:flex;align-items:flex-start;gap:.75rem;padding:.7rem 0;border-bottom:1px dashed #e8f4ec;}
  .ns-tip-item:last-child{border:none;padding-bottom:0;}
  .ns-tip-icon{font-size:1.2rem;flex-shrink:0;margin-top:.05rem;}
  .ns-tip-text{font-size:.8rem;line-height:1.55;color:var(--dark);}
  .ns-tip-text strong{color:var(--green);}
  .ns-streak{display:flex;gap:.45rem;flex-wrap:wrap;margin-top:.7rem;}
  .ns-dot{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.62rem;font-weight:700;}
  .ns-dot.done{background:var(--green);color:white;}
  .ns-dot.miss{background:#f0f7f2;color:#94a3b8;border:1.5px dashed #dde8df;}
  .ns-dot.today{background:var(--gl);color:white;box-shadow:0 0 0 3px rgba(82,183,136,.25);}
  .ns-log-btn{width:100%;padding:.65rem;border:none;border-radius:10px;font-family:'DM Sans',sans-serif;font-size:.83rem;font-weight:700;cursor:pointer;transition:all .2s;margin-top:.9rem;}
  .ns-log-btn.blue{background:#dbeafe;color:#1e40af;}
  .ns-log-btn.blue:hover{background:#3b82f6;color:white;}
  .ns-log-btn.yellow{background:#fef9c3;color:#854d0e;}
  .ns-log-btn.yellow:hover{background:#f59e0b;color:white;}
  .ns-log-btn.green{background:#dcfce7;color:#166534;}
  .ns-log-btn.green:hover{background:#22c55e;color:white;}
  .ns-log-btn.purple{background:#f3e8ff;color:#6b21a8;}
  .ns-log-btn.purple:hover{background:#a855f7;color:white;}
  .ns-toast{position:fixed;bottom:1.5rem;right:1.5rem;background:var(--dark);color:white;padding:.8rem 1.4rem;border-radius:12px;font-size:.85rem;font-weight:600;z-index:9999;transform:translateY(100px);opacity:0;transition:all .4s;pointer-events:none;}
  .ns-toast.show{transform:translateY(0);opacity:1;}
</style>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="sidebar-top">
      <div class="logo">ЁЯМ┐ NutriSync</div>
      <a class="nav-item active" href="/dashboard"><span class="nav-icon">ЁЯУК</span> Dashboard</a>
      <a class="nav-item" href="/planner"><span class="nav-icon">ЁЯН╜я╕П</span> <span data-i18n="tabPlanner">Meal Planner</span></a>
      <a class="nav-item" href="/planner" onclick="setTimeout(()=>{let b=document.querySelectorAll('.tab-btn');if(b[1])b[1].click();},500)"><span class="nav-icon">ЁЯФН</span> Food Analyser</a>
      <a class="nav-item" href="#" onclick="switchDashTab('tracker',null)"><span class="nav-icon">ЁЯУЕ</span> <span data-i18n="monthTracker">Monthly Tracker</span></a>
      <a class="nav-item" href="#" onclick="switchDashTab('nature',null)"><span class="nav-icon">ЁЯМ┐</span> NatureSync</a>
      <a class="nav-item" href="/"><span class="nav-icon">ЁЯПа</span> Home</a>
    </div>
    <div class="sidebar-bottom">
      <div class="user-card">
        <div class="uav" id="uav">?</div>
        <div><div class="uname" id="uname">Loading...</div><div class="uemail" id="uemail"></div></div>
      </div>
      <button class="logout-btn" onclick="logout()">тЖТ Logout</button>
    </div>
  </aside>

  <main class="content">
    <div class="page-header">
      <div><h1 id="welcome">Good morning! ЁЯСЛ</h1><p id="subhead">Here's your nutrition overview for today.</p></div>
      <div style="display:flex;gap:.5rem;align-items:center;">
        <div style="position:relative;display:inline-block">
        <button class="lang-btn" onclick="document.getElementById('dashLangMenu').classList.toggle('open')" id="langBtn">ЁЯМР EN тЦ╛</button>
        <div id="dashLangMenu" style="display:none;position:absolute;right:0;top:110%;background:white;border:1.5px solid #dde8df;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.12);z-index:999;min-width:160px;overflow:hidden;">
          <div onclick="setDashLang('en')" style="padding:.6rem 1rem;cursor:pointer;font-size:.83rem;font-weight:600;transition:background .15s" onmouseover="this.style.background='#f0f7f2'" onmouseout="this.style.background='white'">ЁЯЗмЁЯЗз English</div>
          <div onclick="setDashLang('hi')" style="padding:.6rem 1rem;cursor:pointer;font-size:.83rem;font-weight:600;transition:background .15s" onmouseover="this.style.background='#f0f7f2'" onmouseout="this.style.background='white'">ЁЯЗоЁЯЗ│ рд╣рд┐рдВрджреА</div>
          <div onclick="setDashLang('mr')" style="padding:.6rem 1rem;cursor:pointer;font-size:.83rem;font-weight:600;transition:background .15s" onmouseover="this.style.background='#f0f7f2'" onmouseout="this.style.background='white'">ЁЯЗоЁЯЗ│ рдорд░рд╛рдареА</div>
          <div onclick="setDashLang('es')" style="padding:.6rem 1rem;cursor:pointer;font-size:.83rem;font-weight:600;transition:background .15s" onmouseover="this.style.background='#f0f7f2'" onmouseout="this.style.background='white'">ЁЯЗкЁЯЗ╕ Espa├▒ol</div>
          <div onclick="setDashLang('ta')" style="padding:.6rem 1rem;cursor:pointer;font-size:.83rem;font-weight:600;transition:background .15s" onmouseover="this.style.background='#f0f7f2'" onmouseout="this.style.background='white'">ЁЯЗоЁЯЗ│ родрооро┐ро┤рпН</div>
          <div onclick="setDashLang('gu')" style="padding:.6rem 1rem;cursor:pointer;font-size:.83rem;font-weight:600;transition:background .15s" onmouseover="this.style.background='#f0f7f2'" onmouseout="this.style.background='white'">ЁЯЗоЁЯЗ│ ркЧрлБркЬрк░рк╛ркдрлА</div>
        </div>
      </div>
        <button class="new-btn" onclick="window.location.href='/planner'">+ <span data-i18n="newPlan">New Meal Plan</span></button>
      </div>
    </div>

    <div class="stats">
      <div class="sc green"><div class="si">ЁЯФе</div><div class="sv" id="s-cal">--</div><div class="sl" data-i18n="dailyTarget">Daily Target (kcal)</div><div class="sc2" data-i18n="fromPlan">From your latest plan</div></div>
      <div class="sc"><div class="si">ЁЯПГ</div><div class="sv" id="s-steps">--</div><div class="sl" data-i18n="stepsToday">Steps Today</div><div class="sc2" style="color:#f4a261" data-i18n="connectFit">Connect Google Fit</div></div>
      <div class="sc"><div class="si">тЪб</div><div class="sv" id="s-burned">--</div><div class="sl" data-i18n="calBurned">Cal Burned</div><div class="sc2" style="color:#f4a261" data-i18n="connectFit">Connect Google Fit</div></div>
      <div class="sc"><div class="si">ЁЯУЕ</div><div class="sv" id="s-plans">0</div><div class="sl" data-i18n="plansGenerated">Plans Generated</div><div class="sc2" data-i18n="totalSaved">Total saved plans</div></div>
    </div>

    <!-- DASH TABS -->
    <div class="dash-tabs">
      <button class="dash-tab active" onclick="switchDashTab('overview',this)" data-i18n="overview">Overview</button>
      <button class="dash-tab" onclick="switchDashTab('tracker',this)" data-i18n="monthTracker">Monthly Tracker</button>
      <button class="dash-tab" onclick="switchDashTab('plans',this)" data-i18n="allPlans">All Plans</button>
      <button class="dash-tab" onclick="switchDashTab('nature',this)">ЁЯМ┐ NatureSync</button>
    </div>

    <!-- OVERVIEW TAB -->
    <div class="dash-panel active" id="panel-overview">
      <div class="mgrid">
        <div>
          <div class="card" id="planCard">
            <div class="ct">ЁЯН╜я╕П <span data-i18n="latestPlan">Latest Meal Plan</span></div>
            <div id="planContent">
              <div class="no-plan"><div class="np-icon">ЁЯМ┐</div><p data-i18n="noPlan">No meal plan yet! Generate your first personalized plan.</p><button onclick="window.location.href='/planner'" data-i18n="createFirst">Create My First Plan</button></div>
            </div>
          </div>
        </div>
        <div>
          <div class="fit-card">
            <h3>ЁЯПГ <span data-i18n="activityTracking">Activity Tracking</span></h3>
            <p id="fitStatus" data-i18n="fitDesc">Connect to auto-adjust your calorie targets</p>
            <div class="fit-stats" id="fitStats" style="display:none">
              <div class="fs"><div class="fsv" id="fit-s">--</div><div class="fsl">Steps</div></div>
              <div class="fs"><div class="fsv" id="fit-c">--</div><div class="fsl">Cal Burned</div></div>
              <div class="fs"><div class="fsv" id="fit-m">--</div><div class="fsl">Active Min</div></div>
              <div class="fs"><div class="fsv" id="fit-h">--</div><div class="fsl">Heart Rate</div></div>
            </div>
            <button class="conn-btn" id="fitBtn" onclick="toggleFit()" data-i18n="connectGFit">Connect Google Fit</button>
          </div>
          <div class="card">
            <div class="ct">ЁЯОп <span data-i18n="calorieProgress">Calorie Progress</span></div>
            <div style="text-align:center;padding:.8rem 0;">
              <div class="ring-wrap">
                <svg width="110" height="110" style="transform:rotate(-90deg)">
                  <circle cx="55" cy="55" r="46" fill="none" stroke="#e8f4ec" stroke-width="9"/>
                  <circle cx="55" cy="55" r="46" fill="none" stroke="var(--gl)" stroke-width="9" stroke-dasharray="289" id="ringFill" stroke-dashoffset="289" stroke-linecap="round"/>
                </svg>
                <div class="ring-text"><div class="rv" id="ringPct">0%</div><div class="rl" data-i18n="ofTarget">of target</div></div>
              </div>
            </div>
            <div style="display:flex;justify-content:space-between;font-size:.8rem;color:var(--gray);margin-top:.5rem;">
              <span data-i18n="consumed">Consumed:</span> <strong id="consumed">0</strong> kcal
              <span data-i18n="target">Target:</span> <strong id="rtarget">--</strong> kcal
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- MONTHLY TRACKER TAB -->
    <div class="dash-panel" id="panel-tracker">
      <div class="card">
        <div class="month-header">
          <div class="month-nav">
            <button class="month-btn" onclick="changeMonth(-1)">тЖР</button>
            <div class="month-label" id="monthLabel">LoadingтАж</div>
            <button class="month-btn" onclick="changeMonth(1)">тЖТ</button>
          </div>
          <button class="new-btn" style="font-size:.78rem;padding:.5rem 1rem" onclick="openLogForm()">+ <span data-i18n="logFood">Log Food</span></button>
        </div>

        <!-- Month stats -->
        <div class="month-stats">
          <div class="ms"><div class="msv" id="mt-days">0</div><div class="msl" data-i18n="daysLogged">Days Logged</div></div>
          <div class="ms"><div class="msv" id="mt-avgcal">0</div><div class="msl" data-i18n="avgCalDay">Avg kcal/day</div></div>
          <div class="ms"><div class="msv" id="mt-prot">0g</div><div class="msl" data-i18n="totalProtein">Total Protein</div></div>
          <div class="ms"><div class="msv" id="mt-fiber">0g</div><div class="msl" data-i18n="totalFiber">Total Fiber</div></div>
        </div>

        <!-- Macro breakdown -->
        <div class="macro-chart" id="macroChart">
          <div class="macro-bar">
            <div class="macro-bar-label">Protein</div>
            <svg width="50" height="50" class="macro-bar-ring" style="transform:rotate(-90deg)">
              <circle cx="25" cy="25" r="20" fill="none" stroke="#e8f4ec" stroke-width="5"/>
              <circle cx="25" cy="25" r="20" fill="none" stroke="#52b788" stroke-width="5" stroke-dasharray="125.7" id="ringProt" stroke-dashoffset="125.7" stroke-linecap="round"/>
            </svg>
            <div class="macro-bar-val" id="avgProt">0g</div><div class="macro-bar-unit">avg/day</div>
          </div>
          <div class="macro-bar">
            <div class="macro-bar-label">Carbs</div>
            <svg width="50" height="50" class="macro-bar-ring" style="transform:rotate(-90deg)">
              <circle cx="25" cy="25" r="20" fill="none" stroke="#e8f4ec" stroke-width="5"/>
              <circle cx="25" cy="25" r="20" fill="none" stroke="#3b82f6" stroke-width="5" stroke-dasharray="125.7" id="ringCarbs" stroke-dashoffset="125.7" stroke-linecap="round"/>
            </svg>
            <div class="macro-bar-val" id="avgCarbs">0g</div><div class="macro-bar-unit">avg/day</div>
          </div>
          <div class="macro-bar">
            <div class="macro-bar-label">Fats</div>
            <svg width="50" height="50" class="macro-bar-ring" style="transform:rotate(-90deg)">
              <circle cx="25" cy="25" r="20" fill="none" stroke="#e8f4ec" stroke-width="5"/>
              <circle cx="25" cy="25" r="20" fill="none" stroke="#f59e0b" stroke-width="5" stroke-dasharray="125.7" id="ringFats" stroke-dashoffset="125.7" stroke-linecap="round"/>
            </svg>
            <div class="macro-bar-val" id="avgFats">0g</div><div class="macro-bar-unit">avg/day</div>
          </div>
        </div>

        <!-- Health warnings -->
        <div id="healthWarnings"></div>

        <!-- Daily bars -->
        <div class="ct" style="font-size:.9rem;margin-bottom:.8rem;margin-top:.5rem">ЁЯУК Daily Calorie History</div>
        <div id="dayBars" class="day-bars">
          <div style="color:var(--gray);font-size:.84rem;text-align:center;padding:1rem">Loading food logsтАж</div>
        </div>
      </div>

      <!-- Log food form -->
      <div class="log-form" id="logForm" style="display:none">
        <h4>ЁЯУЭ <span data-i18n="quickLog">Quick Log a Meal</span></h4>
        <input type="text" id="lf-name" placeholder="Meal name (e.g. Dal rice, Chicken curryтАж)" style="width:100%;padding:.6rem .8rem;border:1.5px solid #dde8df;border-radius:9px;font-size:.82rem;margin-bottom:.65rem;font-family:'DM Sans',sans-serif;outline:none;" onfocus="this.style.borderColor='var(--gl)'" onblur="this.style.borderColor='#dde8df'"/>
        <div class="lf-grid">
          <div><label style="font-size:.72rem;font-weight:600;display:block;margin-bottom:.25rem">Calories (kcal)</label><input type="number" id="lf-cal" placeholder="e.g. 450"/></div>
          <div><label style="font-size:.72rem;font-weight:600;display:block;margin-bottom:.25rem">Protein (g)</label><input type="number" id="lf-prot" placeholder="e.g. 25"/></div>
          <div><label style="font-size:.72rem;font-weight:600;display:block;margin-bottom:.25rem">Carbs (g)</label><input type="number" id="lf-carbs" placeholder="e.g. 60"/></div>
          <div><label style="font-size:.72rem;font-weight:600;display:block;margin-bottom:.25rem">Fats (g)</label><input type="number" id="lf-fats" placeholder="e.g. 12"/></div>
        </div>
        <div style="display:flex;gap:.6rem;align-items:center;flex-wrap:wrap;">
          <button class="log-submit" onclick="quickLogFood()" data-i18n="logFood">Log Food</button>
          <button style="padding:.58rem 1.1rem;background:white;border:1.5px solid #dde8df;border-radius:50px;font-family:'DM Sans',sans-serif;font-size:.8rem;cursor:pointer;" onclick="closeLogForm()">Cancel</button>
          <a href="/planner" style="font-size:.78rem;color:#3b82f6;font-weight:600;">ЁЯУ╕ Upload food photo тЖТ</a>
        </div>
      </div>
    </div>

    <!-- ALL PLANS TAB -->
    <div class="dash-panel" id="panel-plans">
      <div class="card">
        <div class="ct">ЁЯУЛ <span data-i18n="allPlans">All My Plans</span></div>
        <div id="pastPlansDetail"></div>
      </div>
    </div>

    <!-- NATURESYNC TAB -->
    <div class="dash-panel" id="panel-nature">

      <!-- Hero score -->
      <div class="ns-hero">
        <h2>ЁЯМ┐ NatureSync</h2>
        <p>Track your hydration, sunlight, sleep &amp; fresh air for a healthier, more natural lifestyle.</p>
        <div class="ns-score-wrap">
          <div class="ns-score-ring">
            <svg width="100" height="100" style="transform:rotate(-90deg)">
              <circle cx="50" cy="50" r="42" fill="none" stroke="rgba(255,255,255,.18)" stroke-width="8"/>
              <circle cx="50" cy="50" r="42" fill="none" stroke="#52b788" stroke-width="8"
                stroke-dasharray="263.9" id="nsScoreRing" stroke-dashoffset="263.9" stroke-linecap="round"/>
            </svg>
            <div class="ns-score-label">
              <div class="ns-score-num" id="nsScoreNum">0</div>
              <span class="ns-score-sub">/ 100</span>
            </div>
          </div>
          <div class="ns-score-text">
            <h3 id="nsScoreTitle">Start Logging Today</h3>
            <p id="nsScoreMsg">Log your water, sun exposure, sleep and outdoor time to see your NatureSync score.</p>
          </div>
        </div>
      </div>

      <!-- 4 tracker cards -->
      <div class="ns-grid">

        <!-- Hydration -->
        <div class="ns-card">
          <div class="ns-card-header">
            <div class="ns-card-title">
              <div class="ns-icon-wrap ns-icon-blue">ЁЯТз</div>
              Hydration
            </div>
            <span class="ns-badge ns-badge-blue" id="hydBadge">0 / 8 glasses</span>
          </div>
          <div class="ns-progress-bar"><div class="ns-progress-fill ns-fill-blue" id="hydBar" style="width:0%"></div></div>
          <div class="ns-progress-nums"><span id="hydValText">0 ml</span><span>Target: 2000 ml</span></div>
          <div class="ns-stepper">
            <button class="ns-step-btn" onclick="adjustHyd(-1)">тИТ</button>
            <div>
              <div class="ns-step-val" id="hydCount">0</div>
              <div class="ns-step-label">glasses (250ml)</div>
            </div>
            <button class="ns-step-btn" onclick="adjustHyd(1)">+</button>
          </div>
          <div class="ns-insight" id="hydInsight">
            <p>ЁЯТб <strong>Tip:</strong> Start your day with a glass of water before checking your phone. Aim for <strong>8 glasses</strong> spread across the day.</p>
          </div>
          <button class="ns-log-btn blue" onclick="saveNatureLog('hydration')">ЁЯТ╛ Save Hydration</button>
        </div>

        <!-- Sunlight -->
        <div class="ns-card">
          <div class="ns-card-header">
            <div class="ns-card-title">
              <div class="ns-icon-wrap ns-icon-yellow">тШАя╕П</div>
              Sunlight Exposure
            </div>
            <span class="ns-badge ns-badge-yellow" id="sunBadge">0 min today</span>
          </div>
          <div class="ns-progress-bar"><div class="ns-progress-fill ns-fill-yellow" id="sunBar" style="width:0%"></div></div>
          <div class="ns-progress-nums"><span id="sunValText">0 min</span><span>Target: 30 min</span></div>
          <div class="ns-slider-wrap">
            <input type="range" min="0" max="120" value="0" class="ns-slider sun" id="sunSlider" oninput="updateSun(this.value)"/>
            <div style="display:flex;justify-content:space-between;font-size:.7rem;color:var(--gray)"><span>0 min</span><span>60 min</span><span>120 min</span></div>
          </div>
          <div class="ns-insight" id="sunInsight">
            <p>ЁЯТб <strong>Tip:</strong> Morning sunlight between 7тАУ9 AM boosts vitamin D and regulates your circadian rhythm. Even <strong>15тАУ20 minutes</strong> makes a big difference!</p>
          </div>
          <button class="ns-log-btn yellow" onclick="saveNatureLog('sunlight')">ЁЯТ╛ Save Sunlight</button>
        </div>

        <!-- Sleep -->
        <div class="ns-card">
          <div class="ns-card-header">
            <div class="ns-card-title">
              <div class="ns-icon-wrap ns-icon-purple">ЁЯМЩ</div>
              Sleep Quality
            </div>
            <span class="ns-badge ns-badge-purple" id="sleepBadge">0 hrs last night</span>
          </div>
          <div class="ns-progress-bar"><div class="ns-progress-fill ns-fill-purple" id="sleepBar" style="width:0%"></div></div>
          <div class="ns-progress-nums"><span id="sleepValText">0 hrs</span><span>Target: 8 hrs</span></div>
          <div class="ns-slider-wrap">
            <input type="range" min="0" max="12" step="0.5" value="0" class="ns-slider sleep" id="sleepSlider" oninput="updateSleep(this.value)"/>
            <div style="display:flex;justify-content:space-between;font-size:.7rem;color:var(--gray)"><span>0 hrs</span><span>6 hrs</span><span>12 hrs</span></div>
          </div>
          <div class="ns-insight" id="sleepInsight">
            <p>ЁЯТб <strong>Tip:</strong> Keep a consistent sleep schedule тАФ even on weekends. Avoid screens 30 minutes before bed and sleep in a cool, dark room.</p>
          </div>
          <button class="ns-log-btn purple" onclick="saveNatureLog('sleep')">ЁЯТ╛ Save Sleep</button>
        </div>

        <!-- Fresh Air / Outdoor -->
        <div class="ns-card">
          <div class="ns-card-header">
            <div class="ns-card-title">
              <div class="ns-icon-wrap ns-icon-green">ЁЯМмя╕П</div>
              Fresh Air & Outdoors
            </div>
            <span class="ns-badge ns-badge-green" id="airBadge">0 min outside</span>
          </div>
          <div class="ns-progress-bar"><div class="ns-progress-fill ns-fill-green" id="airBar" style="width:0%"></div></div>
          <div class="ns-progress-nums"><span id="airValText">0 min</span><span>Target: 45 min</span></div>
          <div class="ns-slider-wrap">
            <input type="range" min="0" max="180" value="0" class="ns-slider air" id="airSlider" oninput="updateAir(this.value)"/>
            <div style="display:flex;justify-content:space-between;font-size:.7rem;color:var(--gray)"><span>0 min</span><span>90 min</span><span>180 min</span></div>
          </div>
          <div class="ns-insight" id="airInsight">
            <p>ЁЯТб <strong>Tip:</strong> A short walk outside reduces cortisol (stress hormone) levels. Even <strong>10 minutes</strong> of outdoor time helps mental clarity and energy.</p>
          </div>
          <button class="ns-log-btn green" onclick="saveNatureLog('air')">ЁЯТ╛ Save Outdoor Time</button>
        </div>

      </div><!-- /.ns-grid -->

      <!-- Remedies section -->
      <div class="ns-tips" id="nsRemedies" style="margin-top:0;background:linear-gradient(135deg,#f8fdf9,#ecfdf5);border:1px solid #bbf7d0;">
        <h4>ЁЯй║ Personalized Remedies & Wellness Tips</h4>
        <div id="nsRemedyList">
          <div style="color:var(--gray);font-size:.82rem;text-align:center;padding:.5rem">Log your nature data above to get personalized remedies.</div>
        </div>
      </div>

      <!-- 7-day streak + tips row -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.2rem">

        <!-- 7-day streak -->
        <div class="ns-tips">
          <h4>ЁЯФе 7-Day NatureSync Streak</h4>
          <p style="font-size:.77rem;color:var(--gray);margin-bottom:.7rem">Days where you hit all 4 nature targets:</p>
          <div class="ns-streak" id="nsStreak"></div>
          <div style="margin-top:.9rem;font-size:.78rem;color:var(--gray)">
            Keep logging daily to build your streak! Each dot = one day.
          </div>
        </div>

        <!-- Nature tips -->
        <div class="ns-tips">
          <h4>ЁЯМ▒ Today's Nature Tips</h4>
          <div class="ns-tip-item">
            <span class="ns-tip-icon">ЁЯТз</span>
            <div class="ns-tip-text">Drink <strong>a glass of water</strong> first thing in the morning тАФ it jumpstarts your metabolism.</div>
          </div>
          <div class="ns-tip-item">
            <span class="ns-tip-icon">тШАя╕П</span>
            <div class="ns-tip-text">Take your morning tea or coffee <strong>outside</strong> to combine sunlight and hydration habits.</div>
          </div>
          <div class="ns-tip-item">
            <span class="ns-tip-icon">ЁЯМЩ</span>
            <div class="ns-tip-text">Set a <strong>sleep alarm</strong> тАФ not just a wake alarm тАФ to remind yourself when to wind down.</div>
          </div>
          <div class="ns-tip-item">
            <span class="ns-tip-icon">ЁЯМмя╕П</span>
            <div class="ns-tip-text"><strong>Open your windows</strong> for 10 minutes each morning to refresh indoor air quality.</div>
          </div>
        </div>

      </div>

    </div><!-- /#panel-nature -->

  </main>
</div>

<div class="plan-modal" id="planModal">
  <div class="pm-inner">
    <button class="pm-close" onclick="document.getElementById('planModal').classList.remove('open')">тЬХ</button>
    <div class="pm-title" id="pmTitle">Meal Plan</div>
    <div id="pmBody"></div>
  </div>
</div>

<script>
// тФАтФАтФА TRANSLATIONS тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА
const T={
  en:{tabPlanner:"Meal Planner",monthTracker:"Monthly Tracker",newPlan:"New Meal Plan",dailyTarget:"Daily Target (kcal)",fromPlan:"From your latest plan",stepsToday:"Steps Today",calBurned:"Cal Burned",connectFit:"Connect Google Fit",plansGenerated:"Plans Generated",totalSaved:"Total saved plans",latestPlan:"Latest Meal Plan",noPlan:"No meal plan yet! Generate your first personalized plan.",createFirst:"Create My First Plan",activityTracking:"Activity Tracking",fitDesc:"Connect to auto-adjust your calorie targets",connectGFit:"Connect Google Fit",calorieProgress:"Calorie Progress",ofTarget:"of target",consumed:"Consumed:",target:"Target:",overview:"Overview",allPlans:"All Plans",daysLogged:"Days Logged",avgCalDay:"Avg kcal/day",totalProtein:"Total Protein",totalFiber:"Total Fiber",logFood:"Log Food",quickLog:"Quick Log a Meal",subhead:"Here's your nutrition overview for today."},
  hi:{tabPlanner:"рднреЛрдЬрди рдпреЛрдЬрдирд╛",monthTracker:"рдорд╛рд╕рд┐рдХ рдЯреНрд░реИрдХрд░",newPlan:"рдирдИ рднреЛрдЬрди рдпреЛрдЬрдирд╛",dailyTarget:"рджреИрдирд┐рдХ рд▓рдХреНрд╖реНрдп (рдХрд┐рд▓реЛрдХреИрд▓реЛрд░реА)",fromPlan:"рдЖрдкрдХреА рдирд╡реАрдирддрдо рдпреЛрдЬрдирд╛ рд╕реЗ",stepsToday:"рдЖрдЬ рдХреЗ рдХрджрдо",calBurned:"рдХреИрд▓реЛрд░реА рдЬрд▓реА",connectFit:"Google Fit рдЬреЛрдбрд╝реЗрдВ",plansGenerated:"рдмрдирд╛рдИ рдЧрдИ рдпреЛрдЬрдирд╛рдПрдВ",totalSaved:"рдХреБрд▓ рд╕рд╣реЗрдЬреА рдЧрдИ рдпреЛрдЬрдирд╛рдПрдВ",latestPlan:"рдирд╡реАрдирддрдо рднреЛрдЬрди рдпреЛрдЬрдирд╛",noPlan:"рдЕрднреА рдХреЛрдИ рднреЛрдЬрди рдпреЛрдЬрдирд╛ рдирд╣реАрдВ! рдЕрдкрдиреА рдкрд╣рд▓реА рд╡реНрдпрдХреНрддрд┐рдЧрдд рдпреЛрдЬрдирд╛ рдмрдирд╛рдПрдВред",createFirst:"рдореЗрд░реА рдкрд╣рд▓реА рдпреЛрдЬрдирд╛ рдмрдирд╛рдПрдВ",activityTracking:"рдЧрддрд┐рд╡рд┐рдзрд┐ рдЯреНрд░реИрдХрд┐рдВрдЧ",fitDesc:"рдЕрдкрдиреЗ рдХреИрд▓реЛрд░реА рд▓рдХреНрд╖реНрдпреЛрдВ рдХреЛ рд╕реНрд╡рддрдГ рд╕рдорд╛рдпреЛрдЬрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЬреЛрдбрд╝реЗрдВ",connectGFit:"Google Fit рдЬреЛрдбрд╝реЗрдВ",calorieProgress:"рдХреИрд▓реЛрд░реА рдкреНрд░рдЧрддрд┐",ofTarget:"рд▓рдХреНрд╖реНрдп рдХрд╛",consumed:"рд╕реЗрд╡рди:",target:"рд▓рдХреНрд╖реНрдп:",overview:"рдЕрд╡рд▓реЛрдХрди",allPlans:"рд╕рднреА рдпреЛрдЬрдирд╛рдПрдВ",daysLogged:"рджрд┐рди рд▓реЙрдЧ рдХрд┐рдП",avgCalDay:"рдФрд╕рдд рдХрд┐рд▓реЛрдХреИрд▓реЛрд░реА/рджрд┐рди",totalProtein:"рдХреБрд▓ рдкреНрд░реЛрдЯреАрди",totalFiber:"рдХреБрд▓ рдлрд╛рдЗрдмрд░",logFood:"рднреЛрдЬрди рд▓реЙрдЧ рдХрд░реЗрдВ",quickLog:"рддреНрд╡рд░рд┐рдд рднреЛрдЬрди рд▓реЙрдЧ",subhead:"рдЖрдЬ рдХреЗ рд▓рд┐рдП рдЖрдкрдХрд╛ рдкреЛрд╖рдг рд╡рд┐рд╡рд░рдгред"},
  mr:{tabPlanner:"рдЬреЗрд╡рдгрд╛рдЪреА рдпреЛрдЬрдирд╛",monthTracker:"рдорд╛рд╕рд┐рдХ рдЯреНрд░реЕрдХрд░",newPlan:"рдирд╡реАрди рдпреЛрдЬрдирд╛",dailyTarget:"рджреИрдирдВрджрд┐рди рд▓рдХреНрд╖реНрдп (kcal)",fromPlan:"рддреБрдордЪреНрдпрд╛ рд╢реЗрд╡рдЯрдЪреНрдпрд╛ рдпреЛрдЬрдиреЗрддреВрди",stepsToday:"рдЖрдЬрдЪреЗ рдкрд╛рд╡рд▓реЗ",calBurned:"рдЬрд│рд╛рд▓реЗрд▓реНрдпрд╛ рдХреЕрд▓рд░реА",connectFit:"Google Fit рдЬреЛрдбрд╛",plansGenerated:"рдмрдирд╡рд▓реЗрд▓реНрдпрд╛ рдпреЛрдЬрдирд╛",totalSaved:"рдПрдХреВрдг рдЬрддрди рдХреЗрд▓реЗрд▓реНрдпрд╛",latestPlan:"рд╢реЗрд╡рдЯрдЪреА рдЬреЗрд╡рдгрд╛рдЪреА рдпреЛрдЬрдирд╛",noPlan:"рдЕрдЬреВрди рдХреЛрдгрддреАрд╣реА рдпреЛрдЬрдирд╛ рдирд╛рд╣реА! рддреБрдордЪреА рдкрд╣рд┐рд▓реА рдпреЛрдЬрдирд╛ рддрдпрд╛рд░ рдХрд░рд╛.",createFirst:"рдорд╛рдЭреА рдкрд╣рд┐рд▓реА рдпреЛрдЬрдирд╛",activityTracking:"рдХреНрд░рд┐рдпрд╛рдХрд▓рд╛рдк рдЯреНрд░реЕрдХрд┐рдВрдЧ",fitDesc:"рдХреЕрд▓рд░реА рд▓рдХреНрд╖реНрдп рдЖрдкреЛрдЖрдк рд╕рдорд╛рдпреЛрдЬрд┐рдд рдХрд░рд╛",connectGFit:"Google Fit рдЬреЛрдбрд╛",calorieProgress:"рдХреЕрд▓рд░реА рдкреНрд░рдЧрддреА",ofTarget:"рд▓рдХреНрд╖реНрдпрд╛рдЪрд╛",consumed:"рд╕реЗрд╡рди:",target:"рд▓рдХреНрд╖реНрдп:",overview:"рдЖрдврд╛рд╡рд╛",allPlans:"рд╕рд░реНрд╡ рдпреЛрдЬрдирд╛",daysLogged:"рджрд┐рд╡рд╕ рд▓реЙрдЧ рдХреЗрд▓реЗ",avgCalDay:"рд╕рд░рд╛рд╕рд░реА kcal/рджрд┐рд╡рд╕",totalProtein:"рдПрдХреВрдг рдкреНрд░рдерд┐рдиреЗ",totalFiber:"рдПрдХреВрдг рдлрд╛рдпрдмрд░",logFood:"рдЬреЗрд╡рдг рд▓реЙрдЧ рдХрд░рд╛",quickLog:"рдЭрдЯрдкрдЯ рдЬреЗрд╡рдг рд▓реЙрдЧ",subhead:"рдЖрдЬрдЪреНрдпрд╛ рдкреЛрд╖рдгрд╛рдЪрд╛ рдЖрдврд╛рд╡рд╛."},
  es:{tabPlanner:"Plan de Comidas",monthTracker:"Seguimiento Mensual",newPlan:"Nuevo Plan",dailyTarget:"Objetivo Diario (kcal)",fromPlan:"De tu ├║ltimo plan",stepsToday:"Pasos Hoy",calBurned:"Calor├нas Quemadas",connectFit:"Conectar Google Fit",plansGenerated:"Planes Generados",totalSaved:"Planes guardados",latestPlan:"├Ъltimo Plan de Comidas",noPlan:"┬бSin plan a├║n! Crea tu primer plan personalizado.",createFirst:"Crear Mi Primer Plan",activityTracking:"Seguimiento de Actividad",fitDesc:"Conecta para ajustar tus calor├нas autom├бticamente",connectGFit:"Conectar Google Fit",calorieProgress:"Progreso de Calor├нas",ofTarget:"del objetivo",consumed:"Consumido:",target:"Objetivo:",overview:"Resumen",allPlans:"Todos los Planes",daysLogged:"D├нas Registrados",avgCalDay:"Prom kcal/d├нa",totalProtein:"Prote├нna Total",totalFiber:"Fibra Total",logFood:"Registrar Comida",quickLog:"Registro R├бpido",subhead:"Tu resumen nutricional de hoy."},
  ta:{tabPlanner:"роЙрогро╡рпБ родро┐роЯрпНроЯроорпН",monthTracker:"рооро╛родро╛роирпНродро┐ро░ роХрогрпНроХро╛рогро┐рокрпНрокрпБ",newPlan:"рокрпБродро┐роп родро┐роЯрпНроЯроорпН",dailyTarget:"родро┐ройроЪро░ро┐ роЗро▓роХрпНроХрпБ (kcal)",fromPlan:"роЙроЩрпНроХро│рпН роХроЯрпИроЪро┐ родро┐роЯрпНроЯродрпНродро┐ро▓ро┐ро░рпБроирпНродрпБ",stepsToday:"роЗройрпНро▒рпИроп роЕроЯро┐роХро│рпН",calBurned:"роОро░ро┐роХрпНроХрокрпНрокроЯрпНроЯ роХро▓рпЛро░ро┐роХро│рпН",connectFit:"Google Fit роЗрогрпИ",plansGenerated:"роЙро░рпБро╡ро╛роХрпНроХрокрпНрокроЯрпНроЯ родро┐роЯрпНроЯроЩрпНроХро│рпН",totalSaved:"роорпКродрпНрод роЪрпЗрооро┐роХрпНроХрокрпНрокроЯрпНроЯро╡рпИ",latestPlan:"роХроЯрпИроЪро┐ роЙрогро╡рпБ родро┐роЯрпНроЯроорпН",noPlan:"родро┐роЯрпНроЯроорпН роЗро▓рпНро▓рпИ! роЙроЩрпНроХро│рпН роорпБродро▓рпН родро┐роЯрпНроЯродрпНродрпИ роЙро░рпБро╡ро╛роХрпНроХрпБроЩрпНроХро│рпН.",createFirst:"роОройрпН роорпБродро▓рпН родро┐роЯрпНроЯроорпН",activityTracking:"роЪрпЖропро▓рпНрокро╛роЯрпБ роХрогрпНроХро╛рогро┐рокрпНрокрпБ",fitDesc:"роХро▓рпЛро░ро┐ роЗро▓роХрпНроХрпБроХро│рпИ родро╛ройро╛роХ роЪро░ро┐роЪрпЖропрпНроп роЗрогрпИроХрпНроХро╡рпБроорпН",connectGFit:"Google Fit роЗрогрпИ",calorieProgress:"роХро▓рпЛро░ро┐ роорпБройрпНройрпЗро▒рпНро▒роорпН",ofTarget:"роЗро▓роХрпНроХро┐ройрпН",consumed:"роЙроЯрпНроХрпКрогрпНроЯродрпБ:",target:"роЗро▓роХрпНроХрпБ:",overview:"роХрогрпНрогрпЛроЯрпНроЯроорпН",allPlans:"роЕройрпИродрпНродрпБ родро┐роЯрпНроЯроЩрпНроХро│рпН",daysLogged:"рокродро┐ро╡рпБ роЪрпЖропрпНрод роиро╛роЯрпНроХро│рпН",avgCalDay:"роЪро░ро╛роЪро░ро┐ kcal/роиро╛ро│рпН",totalProtein:"роорпКродрпНрод рокрпБро░родроорпН",totalFiber:"роорпКродрпНрод роиро╛ро░рпНроЪрпНроЪродрпНродрпБ",logFood:"роЙрогро╡рпБ рокродро┐ро╡рпБ",quickLog:"ро╡ро┐ро░рпИро╡рпБ рокродро┐ро╡рпБ",subhead:"роЗройрпНро▒рпИроп роКроЯрпНроЯроЪрпНроЪродрпНродрпБ роЪрпБро░рпБроХрпНроХроорпН."},
  gu:{tabPlanner:"ркнрлЛркЬрки ркпрлЛркЬркирк╛",monthTracker:"ркорк╛рк╕рк┐ркХ ркЯрлНрк░рлЕркХрк░",newPlan:"ркирк╡рлА ркпрлЛркЬркирк╛",dailyTarget:"ркжрлИркирк┐ркХ рк▓ркХрлНрк╖рлНркп (kcal)",fromPlan:"ркдркорк╛рк░рлА ркЫрлЗрк▓рлНрк▓рлА ркпрлЛркЬркирк╛ркорк╛ркВркерлА",stepsToday:"ркЖркЬркирк╛ рккркЧрк▓рк╛ркВ",calBurned:"ркмрк│рлЗрк▓рлА ркХрлЕрк▓рк░рлА",connectFit:"Google Fit ркЬрлЛркбрлЛ",plansGenerated:"ркмркирк╛рк╡рлЗрк▓ ркпрлЛркЬркирк╛ркУ",totalSaved:"ркХрлБрк▓ рк╕рк╛ркЪрк╡рлЗрк▓",latestPlan:"ркЫрлЗрк▓рлНрк▓рлА ркнрлЛркЬрки ркпрлЛркЬркирк╛",noPlan:"рк╣ркЬрлА ркХрлЛркИ ркпрлЛркЬркирк╛ ркиркерлА! ркдркорк╛рк░рлА рккрлНрк░ркерко рк╡рлНркпркХрлНркдрк┐ркЧркд ркпрлЛркЬркирк╛ ркмркирк╛рк╡рлЛ.",createFirst:"ркорк╛рк░рлА рккрлНрк░ркерко ркпрлЛркЬркирк╛",activityTracking:"ркХрлНрк░рк┐ркпрк╛ркХрк▓рк╛ркк ркЯрлНрк░рлЕркХрк┐ркВркЧ",fitDesc:"ркХрлЕрк▓рк░рлА рк▓ркХрлНрк╖рлНркп ркЖрккрлЛркЖркк ркЧрлЛркарк╡рлЛ",connectGFit:"Google Fit ркЬрлЛркбрлЛ",calorieProgress:"ркХрлЕрк▓рк░рлА рккрлНрк░ркЧркдрк┐",ofTarget:"рк▓ркХрлНрк╖рлНркпркирлЛ",consumed:"рк╡рккрк░рк╛рк╢:",target:"рк▓ркХрлНрк╖рлНркп:",overview:"рк╡рк┐рк╣ркВркЧрк╛рк╡рк▓рлЛркХрки",allPlans:"ркмркзрлА ркпрлЛркЬркирк╛ркУ",daysLogged:"рк▓рлЙркЧ ркХрк░рлЗрк▓ ркжрк┐рк╡рк╕рлЛ",avgCalDay:"рк╕рк░рлЗрк░рк╛рк╢ kcal/ркжрк┐рк╡рк╕",totalProtein:"ркХрлБрк▓ рккрлНрк░рлЛркЯрлАрки",totalFiber:"ркХрлБрк▓ рклрк╛ркЗркмрк░",logFood:"ркнрлЛркЬрки рк▓рлЙркЧ",quickLog:"ркЭркбрккрлА ркнрлЛркЬрки рк▓рлЙркЧ",subhead:"ркЖркЬ ркорк╛ркЯрлЗ ркдркорк╛рк░рлЛ рккрлЛрк╖ркг рк╕рк╛рк░рк╛ркВрк╢."}
};
let currentLang='en';
function setDashLang(lang){
  currentLang=lang;
  const names={'en':'ЁЯМР EN тЦ╛','hi':'ЁЯМР рд╣рд┐рдВ тЦ╛','mr':'ЁЯМР рдорд░ тЦ╛','es':'ЁЯМР ES тЦ╛','ta':'ЁЯМР родрооро┐ тЦ╛','gu':'ЁЯМР ркЧрлБ тЦ╛'};
  document.getElementById('langBtn').textContent=names[lang]||'ЁЯМР EN тЦ╛';
  document.getElementById('dashLangMenu').classList.remove('open');
  applyT();
}
function toggleLang(){ setDashLang(['en','hi','mr','es','ta','gu'][(['en','hi','mr','es','ta','gu'].indexOf(currentLang)+1)%6]); }
document.addEventListener('click',function(e){
  const m=document.getElementById('dashLangMenu');
  if(m&&!e.target.closest('#dashLangMenu')&&e.target.id!=='langBtn')m.classList.remove('open');
});
function applyT(){
  const t=T[currentLang];
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const k=el.getAttribute('data-i18n');
    if(t[k])el.textContent=t[k];
  });
  document.getElementById('subhead').textContent=t.subhead;
}

// тФАтФАтФА STATE тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА
let allPlans=[],fitConn=false;
let currentMonth=new Date().toISOString().slice(0,7);

// тФАтФАтФА DASH TABS тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА
function switchDashTab(name, btn){
  document.querySelectorAll('.dash-panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.dash-tab').forEach(b=>b.classList.remove('active'));
  document.getElementById('panel-'+name).classList.add('active');
  if(btn) btn.classList.add('active');
  if(name==='tracker') loadMonthlyData();
  if(name==='plans') renderAllPlans();
  if(name==='nature') initNatureSync();
}

// тФАтФАтФА INIT тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА
async function init(){
  const h=new Date().getHours();
  const g=h<12?'Good morning':h<17?'Good afternoon':'Good evening';
  document.getElementById('welcome').textContent=g+'! ЁЯСЛ';
  document.getElementById('monthLabel').textContent=formatMonth(currentMonth);

  const token=localStorage.getItem('token');
  const name=localStorage.getItem('userName');
  if(name){
    document.getElementById('uname').textContent=name;
    document.getElementById('uav').textContent=name[0].toUpperCase();
    document.getElementById('welcome').textContent=g+', '+name+'! ЁЯСЛ';
  }
  if(token){
    try{
      const r=await fetch(window.API_BASE + '/api/user-info',{headers:{'Authorization':'Bearer '+token}});
      if(r.ok){
        const u=await r.json();
        document.getElementById('uname').textContent=u.name;
        document.getElementById('uemail').textContent=u.email;
        document.getElementById('uav').textContent=u.name[0].toUpperCase();
        document.getElementById('welcome').textContent=g+', '+u.name+'! ЁЯСЛ';
      }
    }catch{}
    try{
      const r=await fetch(window.API_BASE + '/api/my-plans',{headers:{'Authorization':'Bearer '+token}});
      if(r.ok){
        allPlans=await r.json();
        document.getElementById('s-plans').textContent=allPlans.length;
        if(allPlans.length>0)renderLatestPlan(allPlans[0]);
        renderAllPlans();
      }
    }catch(e){document.getElementById('s-plans').textContent='0';}
  }else{
    document.getElementById('uname').textContent='Guest';
    document.getElementById('uemail').textContent='Not logged in';
  }
}

function formatMonth(m){
  const [y,mo]=m.split('-');
  const months=['January','February','March','April','May','June','July','August','September','October','November','December'];
  return months[parseInt(mo)-1]+' '+y;
}

function changeMonth(dir){
  const d=new Date(currentMonth+'-01');
  d.setMonth(d.getMonth()+dir);
  currentMonth=d.toISOString().slice(0,7);
  document.getElementById('monthLabel').textContent=formatMonth(currentMonth);
  loadMonthlyData();
}

async function loadMonthlyData(){
  const token=localStorage.getItem('token');
  if(!token){
    document.getElementById('dayBars').innerHTML='<div style="color:var(--gray);font-size:.84rem;text-align:center;padding:1rem">Please login to view food logs.</div>';
    return;
  }
  try{
    const r=await fetch(window.API_BASE + `/api/food-logs/monthly-summary?month=${currentMonth}`,{headers:{'Authorization':'Bearer '+token}});
    if(!r.ok) throw new Error('Failed to load');
    const data=await r.json();
    renderMonthlyData(data);
  }catch(e){
    document.getElementById('mt-days').textContent='0';
    document.getElementById('mt-avgcal').textContent='0';
    document.getElementById('mt-prot').textContent='0g';
    document.getElementById('mt-fiber').textContent='0g';
    document.getElementById('dayBars').innerHTML='<div style="color:var(--gray);font-size:.84rem;text-align:center;padding:1.5rem"><div style="font-size:2rem;margin-bottom:.5rem">ЁЯУЭ</div><p style="margin-bottom:.8rem">No food logs yet for this month.</p><button onclick="openLogForm()" style="padding:.6rem 1.4rem;background:var(--green);color:white;border:none;border-radius:50px;font-size:.84rem;font-weight:600;cursor:pointer">+ Log Your First Meal</button></div>';
    document.getElementById('healthWarnings').innerHTML='';
  }
}

function renderMonthlyData(data){
  document.getElementById('mt-days').textContent=data.days_logged||0;
  document.getElementById('mt-avgcal').textContent=data.avg_daily_calories||0;
  document.getElementById('mt-prot').textContent=(data.total_protein||0)+'g';
  document.getElementById('mt-fiber').textContent=(data.total_fiber||0)+'g';

  const days=data.days_logged||1;
  const avgP=data.avg_daily_protein||Math.round((data.total_protein||0)/days);
  const avgC=Math.round((data.total_carbs||0)/days);
  const avgF=Math.round((data.total_fats||0)/days);
  document.getElementById('avgProt').textContent=avgP+'g';
  document.getElementById('avgCarbs').textContent=avgC+'g';
  document.getElementById('avgFats').textContent=avgF+'g';

  // Ring offsets (circumference=125.7)
  const pPct=Math.min(avgP/80,1);  // target ~80g protein
  const cPct=Math.min(avgC/200,1); // target ~200g carbs
  const fPct=Math.min(avgF/65,1);  // target ~65g fat
  document.getElementById('ringProt').style.strokeDashoffset=125.7*(1-pPct);
  document.getElementById('ringCarbs').style.strokeDashoffset=125.7*(1-cPct);
  document.getElementById('ringFats').style.strokeDashoffset=125.7*(1-fPct);

  // Health warnings
  const wEl=document.getElementById('healthWarnings');
  if((data.warnings||[]).length>0){
    wEl.innerHTML=`<div class="ct" style="font-size:.9rem;margin-bottom:.6rem">тЪая╕П Health Alerts</div>`+
      data.warnings.map(w=>`
        <div class="warn-box ${w.level} warn-${w.level}">
          <div class="warn-icon">${w.icon}</div>
          <div><div class="warn-title">${w.title}</div><div class="warn-msg">${w.message}</div></div>
        </div>`).join('');
  }else{
    wEl.innerHTML=data.days_logged>0?`<div style="background:#f0fdf4;border:1.5px solid #86efac;border-radius:10px;padding:.8rem 1rem;margin-bottom:.8rem;font-size:.8rem;color:#166534;display:flex;align-items:center;gap:.5rem;"><span>тЬЕ</span><span>Great job! No nutrition warnings this month.</span></div>`:'';
  }

  // Day bars
  const daily=data.daily||[];
  const maxCal=Math.max(...daily.map(d=>d.calories),1);
  if(daily.length===0){
    document.getElementById('dayBars').innerHTML='<div style="color:var(--gray);font-size:.84rem;text-align:center;padding:1rem">No food logs yet. <a href="#" onclick="openLogForm()" style="color:var(--green);font-weight:600">Start logging тЖТ</a></div>';
    return;
  }
  document.getElementById('dayBars').innerHTML=daily.map(d=>{
    const pct=Math.min(d.calories/maxCal*100,100);
    const day=new Date(d.date+'T12:00:00').getDate();
    return`<div class="day-bar-row">
      <div class="day-bar-label">${day}</div>
      <div class="day-bar-track"><div class="day-bar-fill" style="width:${pct}%"></div></div>
      <div class="day-bar-val">${Math.round(d.calories)} kcal</div>
    </div>`;
  }).join('');
}

function openLogForm(){
  document.getElementById('logForm').style.display='block';
  document.getElementById('lf-name').focus();
  document.getElementById('logForm').scrollIntoView({behavior:'smooth'});
}
function closeLogForm(){document.getElementById('logForm').style.display='none';}

async function quickLogFood(){
  const token=localStorage.getItem('token');
  if(!token){alert('Please login to log food');return;}
  const name=document.getElementById('lf-name').value.trim();
  if(!name){alert('Please enter meal name');return;}
  const payload={
    meal_name:name,
    calories:parseFloat(document.getElementById('lf-cal').value)||0,
    protein:parseFloat(document.getElementById('lf-prot').value)||0,
    carbs:parseFloat(document.getElementById('lf-carbs').value)||0,
    fats:parseFloat(document.getElementById('lf-fats').value)||0,
    logged_date:new Date().toISOString().split('T')[0]
  };
  try{
    const r=await fetch(window.API_BASE + '/api/log-food',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+token},body:JSON.stringify(payload)});
    if(r.ok){
      ['lf-name','lf-cal','lf-prot','lf-carbs','lf-fats'].forEach(id=>document.getElementById(id).value='');
      closeLogForm();
      loadMonthlyData();
    }else throw new Error('Failed');
  }catch(e){alert('Could not log food: '+e.message);}
}

// тФАтФАтФА PLAN RENDERING тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА
function renderLatestPlan(plan){
  const target=plan.target_calories||2000;
  document.getElementById('s-cal').textContent=target.toLocaleString();
  document.getElementById('rtarget').textContent=target.toLocaleString();
  const days=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  const planDays=plan.plan||[];
  let html=`
    <div class="plan-sum">
      <div class="pdate">${new Date(plan.created_at).toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'})}</div>
      <div class="pname">${plan.goal||'Custom'} Plan</div>
      <div class="macros">
        <div class="mb"><div class="mv">${plan.bmr||'-'}</div><div class="ml">BMR</div></div>
        <div class="mb"><div class="mv">${plan.tdee||'-'}</div><div class="ml">TDEE</div></div>
        <div class="mb"><div class="mv">${target}</div><div class="ml">Target kcal</div></div>
      </div>
    </div>
    <div class="day-scroll" id="dayPills">`;
  days.forEach((d,i)=>{html+=`<div class="dp${i===0?' active':''}" onclick="switchDay(${i},this)">${d}</div>`;});
  html+=`</div><div id="dayMeals">`;
  if(planDays.length>0){html+=renderMeals(planDays[0].meals||[]);}
  else{html+='<p style="color:var(--gray);font-size:.87rem">No meal data available.</p>';}
  html+=`</div>`;
  document.getElementById('planContent').innerHTML=html;
  window._planDays=planDays;
}

function renderMeals(meals){
  const badges={Breakfast:'b',Lunch:'l',Dinner:'d','Mid-Morning':'s',Evening:'s'};
  return meals.map(m=>`
    <div class="mr">
      <div><span class="mt-badge ${badges[m.type]||'s'}">${m.type}</span>
        <div class="mn">${m.name}</div>
        ${m.ingredients?`<div class="ingr-sm">ЁЯзВ ${(m.ingredients||[]).slice(0,4).map(i=>typeof i==='string'?i:i.name).join(', ')}${m.ingredients.length>4?'тАж':''}</div>`:''}
      </div>
      <div class="mc">${m.cal} kcal</div>
    </div>`).join('');
}

function switchDay(i,el){
  document.querySelectorAll('.dp').forEach(p=>p.classList.remove('active'));
  el.classList.add('active');
  const days=window._planDays||[];
  const meals=(days[i]||{}).meals||[];
  document.getElementById('dayMeals').innerHTML=meals.length?renderMeals(meals):'<p style="color:var(--gray);font-size:.87rem">No meals for this day.</p>';
  updateRing(60);
}

function updateRing(pct){
  const circle=document.getElementById('ringFill');
  const circumference=289;
  const offset=circumference-(circumference*pct/100);
  circle.style.strokeDashoffset=offset;
  document.getElementById('ringPct').textContent=pct+'%';
  const target=parseInt(document.getElementById('rtarget').textContent.replace(',',''))||2000;
  document.getElementById('consumed').textContent=Math.round(target*pct/100).toLocaleString();
}

function renderAllPlans(){
  const container=document.getElementById('pastPlansDetail');
  if(allPlans.length===0){
    container.innerHTML='<p style="color:var(--gray);font-size:.83rem;text-align:center;padding:.5rem">No plans yet. <a href="/planner" style="color:var(--green);font-weight:600">Create one тЖТ</a></p>';
    return;
  }
  container.innerHTML=allPlans.map((p,i)=>`
    <div class="pi">
      <div>
        <div class="pidate">${new Date(p.created_at).toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'})}</div>
        <div class="pigoal">${p.goal||'Custom'} ┬╖ ${p.target_calories||'-'} kcal ┬╖ BMR: ${p.bmr||'-'}</div>
      </div>
      <span class="piv" onclick="viewPlan(${i})">View тЖТ</span>
    </div>`).join('');
}

function viewPlan(i){
  const plan=allPlans[i];
  document.getElementById('pmTitle').textContent=(plan.goal||'Custom')+' Plan тАУ '+new Date(plan.created_at).toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'});
  const body=document.getElementById('pmBody');
  body.innerHTML=(plan.plan||[]).map(day=>`
    <div class="pm-day">
      <h4>${day.day}</h4>
      ${(day.meals||[]).map(m=>`<div style="display:flex;justify-content:space-between;padding:.35rem 0;border-bottom:1px dashed #e0e0e0;font-size:.84rem"><div><strong>${m.type}</strong> тАФ ${m.name}${m.ingredients?'<br><span style="font-size:.72rem;color:#94a3b8">'+( m.ingredients||[]).slice(0,4).map(i=>typeof i==='string'?i:i.name).join(', ')+'</span>':''}</div><span style="color:var(--green);font-weight:600">${m.cal} kcal</span></div>`).join('')}
    </div>`).join('');
  document.getElementById('planModal').classList.add('open');
}

document.getElementById('planModal').addEventListener('click',e=>{if(e.target===e.currentTarget)e.currentTarget.classList.remove('open');});

function toggleFit(){
  if(!fitConn){
    fitConn=true;
    document.getElementById('fitStatus').textContent='Simulating activity data (demo mode)';
    document.getElementById('fitStats').style.display='grid';
    document.getElementById('fitBtn').textContent='тЬУ Connected (Demo)';
    document.getElementById('fitBtn').classList.add('conn');
    const steps=Math.floor(Math.random()*8000)+3000;
    const burned=Math.floor(steps*0.04);
    const mins=Math.floor(steps/200);
    document.getElementById('fit-s').textContent=steps.toLocaleString();
    document.getElementById('fit-c').textContent=burned;
    document.getElementById('fit-m').textContent=mins;
    document.getElementById('fit-h').textContent=Math.floor(Math.random()*20)+65;
    document.getElementById('s-steps').textContent=steps.toLocaleString();
    document.getElementById('s-burned').textContent=burned;
    const base=parseInt(document.getElementById('s-cal').textContent.replace(',',''))||2000;
    let adj=base;
    if(steps<4000)adj=Math.round(base*0.9);
    else if(steps>10000)adj=Math.round(base*1.1);
    if(adj!==base){document.getElementById('s-cal').textContent=adj.toLocaleString();document.getElementById('rtarget').textContent=adj.toLocaleString();}
    updateRing(Math.floor(burned/adj*100*1.8));
  }else{
    alert('In production: This connects to Google Fit OAuth.\nFor demo, data is simulated above.');
  }
}

function logout(){
  localStorage.removeItem('token');
  localStorage.removeItem('userName');
  window.location.href='/';
}

// тФАтФАтФА NATURESYNC тФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФАтФА
const NS_KEY = 'natureSyncData';

function getNSData(){
  try{ return JSON.parse(localStorage.getItem(NS_KEY)) || {}; }catch{ return {}; }
}
function setNSData(d){ localStorage.setItem(NS_KEY, JSON.stringify(d)); }

function getTodayKey(){ return new Date().toISOString().split('T')[0]; }

// State
let nsState = { hydration: 0, sunlight: 0, sleep: 0, air: 0 };

function initNatureSync(){
  const data = getNSData();
  const today = getTodayKey();
  if(data[today]){
    nsState = { ...nsState, ...data[today] };
    document.getElementById('hydCount').textContent = nsState.hydration;
    document.getElementById('sunSlider').value = nsState.sunlight;
    document.getElementById('sleepSlider').value = nsState.sleep;
    document.getElementById('airSlider').value = nsState.air;
  }
  renderAllNS();
  renderNSStreak(data);
}

function adjustHyd(delta){
  nsState.hydration = Math.max(0, Math.min(20, nsState.hydration + delta));
  document.getElementById('hydCount').textContent = nsState.hydration;
  renderHydration();
  recalcNSScore();
}
function updateSun(v){ nsState.sunlight = parseInt(v); renderSunlight(); recalcNSScore(); }
function updateSleep(v){ nsState.sleep = parseFloat(v); renderSleep(); recalcNSScore(); }
function updateAir(v){ nsState.air = parseInt(v); renderAir(); recalcNSScore(); }

function renderHydration(){
  const ml = nsState.hydration * 250;
  const pct = Math.min(ml / 2000 * 100, 100);
  document.getElementById('hydBar').style.width = pct + '%';
  document.getElementById('hydValText').textContent = ml + ' ml';
  document.getElementById('hydBadge').textContent = nsState.hydration + ' / 8 glasses';
  const h = nsState.hydration;
  let msg = 'ЁЯТб <strong>Tip:</strong> Start your day with a glass of water before checking your phone. Aim for <strong>8 glasses</strong> spread across the day.';
  if(h >= 8) msg = 'ЁЯОЙ <strong>Amazing!</strong> You\'ve hit your daily hydration goal! Staying well-hydrated boosts energy, focus and skin health.';
  else if(h >= 5) msg = 'ЁЯСН <strong>Good progress!</strong> You\'re more than halfway there. Keep sipping every 1тАУ2 hours to stay hydrated.';
  else if(h >= 2) msg = 'тЪая╕П <strong>Keep going!</strong> You need about <strong>'+(8-h)+' more glasses</strong> to reach your goal. Set a phone reminder!';
  document.getElementById('hydInsight').innerHTML = '<p>' + msg + '</p>';
}

function renderSunlight(){
  const v = nsState.sunlight;
  const pct = Math.min(v / 30 * 100, 100);
  document.getElementById('sunBar').style.width = pct + '%';
  document.getElementById('sunValText').textContent = v + ' min';
  document.getElementById('sunBadge').textContent = v + ' min today';
  let msg = 'ЁЯТб <strong>Tip:</strong> Morning sunlight between 7тАУ9 AM boosts vitamin D and regulates your circadian rhythm.';
  if(v >= 30) msg = 'ЁЯМЯ <strong>Excellent!</strong> You\'ve met your sunlight goal. Vitamin D supports immunity, mood and bone health.';
  else if(v >= 15) msg = 'тЬЕ <strong>Halfway there!</strong> Try to get another <strong>'+(30-v)+' minutes</strong> of sun. A short lunch walk works great!';
  else if(v > 0) msg = 'тШБя╕П <strong>Getting started!</strong> You have <strong>'+(30-v)+' min</strong> remaining. Even cloudy-day outdoor time counts!';
  document.getElementById('sunInsight').innerHTML = '<p>' + msg + '</p>';
}

function renderSleep(){
  const v = nsState.sleep;
  const pct = Math.min(v / 8 * 100, 100);
  document.getElementById('sleepBar').style.width = pct + '%';
  document.getElementById('sleepValText').textContent = v + ' hrs';
  document.getElementById('sleepBadge').textContent = v + ' hrs last night';
  let msg = 'ЁЯТб <strong>Tip:</strong> Keep a consistent sleep schedule. Avoid screens 30 min before bed.';
  if(v >= 8) msg = 'ЁЯМЩ <strong>Well rested!</strong> 8+ hours supports memory consolidation, hormone balance and immune function.';
  else if(v >= 6) msg = 'ЁЯЩВ <strong>Almost there!</strong> You\'re at ' + v + ' hrs. Try going to bed <strong>'+(8-v)+' hour(s) earlier</strong> tonight.';
  else if(v > 0) msg = 'ЁЯШ┤ <strong>Need more rest!</strong> Under 6 hours raises cortisol and impairs decision-making. Prioritise sleep tonight!';
  document.getElementById('sleepInsight').innerHTML = '<p>' + msg + '</p>';
}

function renderAir(){
  const v = nsState.air;
  const pct = Math.min(v / 45 * 100, 100);
  document.getElementById('airBar').style.width = pct + '%';
  document.getElementById('airValText').textContent = v + ' min';
  document.getElementById('airBadge').textContent = v + ' min outside';
  let msg = 'ЁЯТб <strong>Tip:</strong> A short walk outside reduces cortisol levels. Even <strong>10 minutes</strong> helps mental clarity.';
  if(v >= 45) msg = 'ЁЯМ│ <strong>Nature champion!</strong> Excellent outdoor time. Fresh air exposure lowers blood pressure and boosts mood.';
  else if(v >= 20) msg = 'ЁЯМ┐ <strong>Good start!</strong> Try to add another <strong>'+(45-v)+' minutes</strong> тАФ even a short evening walk counts!';
  else if(v > 0) msg = 'ЁЯЪ╢ <strong>Keep going!</strong> You need <strong>'+(45-v)+' more minutes</strong> outdoors. A walk after meals is a great habit.';
  document.getElementById('airInsight').innerHTML = '<p>' + msg + '</p>';
}

function renderAllNS(){
  renderHydration(); renderSunlight(); renderSleep(); renderAir(); recalcNSScore();
}

function recalcNSScore(){
  const hydPct   = Math.min(nsState.hydration / 8, 1);
  const sunPct   = Math.min(nsState.sunlight / 30, 1);
  const sleepPct = Math.min(nsState.sleep / 8, 1);
  const airPct   = Math.min(nsState.air / 45, 1);
  const score    = Math.round((hydPct + sunPct + sleepPct + airPct) / 4 * 100);
  document.getElementById('nsScoreNum').textContent = score;
  const circumference = 263.9;
  const offset = circumference - (circumference * score / 100);
  document.getElementById('nsScoreRing').style.strokeDashoffset = offset;
  let title, msg;
  if(score === 100){ title = 'ЁЯПЖ Perfect NatureSync Day!'; msg = 'You\'ve hit all your nature targets тАФ hydration, sunlight, sleep & fresh air. Incredible!'; }
  else if(score >= 75){ title = 'ЁЯМЯ Almost There!'; msg = 'You\'re doing great! Just a little more to complete today\'s NatureSync goals.'; }
  else if(score >= 50){ title = 'ЁЯМ▒ Good Progress'; msg = 'Halfway through your nature goals. Keep logging and you\'ll have a great day!'; }
  else if(score > 0){ title = 'ЁЯМдя╕П Getting Started'; msg = 'Nice тАФ you\'ve begun! Each small habit adds up. Keep logging your nature activities.'; }
  else { title = 'Start Logging Today'; msg = 'Log your water, sun exposure, sleep and outdoor time to see your NatureSync score.'; }
  document.getElementById('nsScoreTitle').textContent = title;
  document.getElementById('nsScoreMsg').textContent = msg;
  renderNSRemedies();
}

function renderNSRemedies(){
  const el = document.getElementById('nsRemedyList');
  if(!el) return;
  const remedies = [];

  // Hydration remedies
  const hyd = nsState.hydration;
  if(hyd === 0){
    remedies.push({icon:'ЁЯТз',color:'#1e40af',bg:'#dbeafe',title:'Start Hydrating Now',desc:'Even mild dehydration causes fatigue and brain fog. Drink a glass of water right now and set an hourly reminder.'});
  } else if(hyd < 4){
    remedies.push({icon:'ЁЯТз',color:'#1e40af',bg:'#dbeafe',title:'Increase Water Intake',desc:'You\'re drinking '+(hyd*250)+'ml but need 2000ml. Try keeping a water bottle at your desk. Add lemon or cucumber for taste.'});
  } else if(hyd < 8){
    remedies.push({icon:'ЁЯТз',color:'#0369a1',bg:'#e0f2fe',title:'Almost at Hydration Goal',desc:''+(8-hyd)+' more glasses to go! Drink a glass before each meal and one after waking тАФ simple ways to hit the target.'});
  }

  // Sunlight remedies
  const sun = nsState.sunlight;
  if(sun === 0){
    remedies.push({icon:'тШАя╕П',color:'#92400e',bg:'#fef9c3',title:'Get Outdoors тАФ Vitamin D Deficiency Risk',desc:'Zero sunlight today. Prolonged deficiency weakens immunity and causes mood dips. Even 5 minutes on your balcony helps right now.'});
  } else if(sun < 15){
    remedies.push({icon:'тШАя╕П',color:'#92400e',bg:'#fef3c7',title:'Low Sunlight Exposure',desc:'Under 15 min of sun may not synthesize enough Vitamin D. Take a 15-min morning walk to boost serotonin and immune function.'});
  } else if(sun < 30){
    remedies.push({icon:'тШАя╕П',color:'#b45309',bg:'#fef9c3',title:'Top Up Your Sunlight',desc:'You\'re at '+sun+' min тАФ just '+(30-sun)+' more needed. Eat lunch outside or do your stretches in the sun to finish your goal.'});
  }

  // Sleep remedies
  const slp = nsState.sleep;
  if(slp === 0){
    remedies.push({icon:'ЁЯМЩ',color:'#6b21a8',bg:'#f3e8ff',title:'No Sleep Logged тАФ Rest is Critical',desc:'Please log your sleep. Chronic sleep deprivation raises cortisol, slows metabolism and impairs memory. Prioritize 7тАУ8 hrs tonight.'});
  } else if(slp < 5){
    remedies.push({icon:'ЁЯМЩ',color:'#6b21a8',bg:'#f3e8ff',title:'Critically Low Sleep',desc:'Under 5 hrs seriously impairs cognitive function and hormonal balance. Remedy: skip caffeine after 2 PM and set a wind-down alarm at 9:30 PM tonight.'});
  } else if(slp < 7){
    remedies.push({icon:'ЁЯМЩ',color:'#7e22ce',bg:'#faf5ff',title:'Sleep Deficit Detected',desc:'You slept '+slp+' hrs but need 7тАУ8. A consistent bedtime improves sleep quality. Try dimming lights 1 hour before bed and avoiding heavy meals late at night.'});
  }

  // Fresh air remedies
  const air = nsState.air;
  if(air === 0){
    remedies.push({icon:'ЁЯМмя╕П',color:'#166534',bg:'#dcfce7',title:'Go Outside тАФ Indoor Air Can Be Toxic',desc:'Indoor air quality is often 2тАУ5x worse than outdoor. Open windows now and plan a 10-min walk. Fresh air lowers anxiety and sharpens focus.'});
  } else if(air < 20){
    remedies.push({icon:'ЁЯМмя╕П',color:'#15803d',bg:'#dcfce7',title:'More Outdoor Time Needed',desc:'You\'ve had just '+air+' min outside. A short stroll after dinner adds outdoor time without disrupting your schedule and helps with digestion too.'});
  }

  // Positive reinforcement when doing great
  if(hyd >= 8 && sun >= 30 && slp >= 7 && air >= 45){
    remedies.push({icon:'ЁЯПЖ',color:'#166534',bg:'#f0fdf4',title:'Perfect Day тАФ Keep It Up!',desc:'You\'ve met all NatureSync targets today. Consistency is key тАФ even 3 consecutive days of this routine produces measurable wellness improvements.'});
  } else if(remedies.length === 0){
    remedies.push({icon:'ЁЯМ┐',color:'#2d6a4f',bg:'#f0fdf4',title:'Looking Good!',desc:'You\'re on track with your nature habits. Keep logging throughout the day to maintain your NatureSync streak.'});
  }

  el.innerHTML = remedies.map(r => `
    <div class="ns-tip-item" style="background:${r.bg};border-radius:10px;padding:.75rem 1rem;margin-bottom:.55rem;border-bottom:none;">
      <span class="ns-tip-icon">${r.icon}</span>
      <div class="ns-tip-text"><strong style="color:${r.color}">${r.title}</strong><br>${r.desc}</div>
    </div>`).join('');
}

function saveNatureLog(type){
  const data = getNSData();
  const today = getTodayKey();
  if(!data[today]) data[today] = {};
  data[today][type] = nsState[type];
  setNSData(data);
  renderNSStreak(data);
  showNSToast(type);
}

function showNSToast(type){
  const labels = { hydration:'ЁЯТз Hydration saved!', sunlight:'тШАя╕П Sunlight logged!', sleep:'ЁЯМЩ Sleep logged!', air:'ЁЯМмя╕П Outdoor time saved!' };
  let t = document.getElementById('nsToast');
  if(!t){ t = document.createElement('div'); t.id='nsToast'; t.className='ns-toast'; document.body.appendChild(t); }
  t.textContent = labels[type] || 'тЬЕ Saved!';
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'), 2800);
}

function renderNSStreak(data){
  const el = document.getElementById('nsStreak');
  if(!el) return;
  const today = new Date();
  let html = '';
  for(let i = 6; i >= 0; i--){
    const d = new Date(today); d.setDate(today.getDate() - i);
    const key = d.toISOString().split('T')[0];
    const dayData = data[key] || {};
    const complete = (dayData.hydration||0)>=8 && (dayData.sunlight||0)>=30 && (dayData.sleep||0)>=8 && (dayData.air||0)>=45;
    const isToday = i === 0;
    const label = ['Su','Mo','Tu','We','Th','Fr','Sa'][d.getDay()];
    const cls = isToday ? 'today' : (complete ? 'done' : 'miss');
    html += `<div class="ns-dot ${cls}" title="${key}">${label}</div>`;
  }
  el.innerHTML = html;
}

init();
</script>
</body>
</html>